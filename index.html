<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tori's PTO Advisor - Wyoming State Worker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .balance-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .balance-display h2 {
            font-size: 48px;
            margin-bottom: 5px;
        }
        
        .balance-display p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        /* Condensed trip cards */
        .trip-card {
            background: #e8f0ff;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .trip-card.admin {
            background: #f5f5f5;
            border-left-color: #6c757d;
        }
        
        .trip-main-line {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 300px;
        }
        
        .trip-emoji {
            font-size: 18px;
        }
        
        .trip-divider {
            color: #999;
            margin: 0 4px;
        }
        
        .trip-actions {
            display: flex;
            gap: 6px;
        }
        
        .trip-notes-compact {
            width: 100%;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 12px;
            color: #666;
        }
        
        .trip-balance-compact {
            width: 100%;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 12px;
            color: #667eea;
            font-weight: 500;
        }
        
        .no-trips {
            text-align: center;
            padding: 40px;
            color: #adb5bd;
            font-style: italic;
        }
        
        .holiday-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .holiday-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .holiday-item strong {
            color: #667eea;
        }
        
        .hidden {
            display: none;
        }
        
        .projection {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .projection h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        /* Projection table styling */
        .projection-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .projection-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .projection-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .projection-table tr:hover {
            background: #f8f9fa;
        }
        
        .projection-table tr.has-pto {
            background: #fff3cd;
            font-weight: 600;
        }
        
        .projection-table tr.has-pto td {
            color: #856404;
        }
        
        .projection-table .pto-used {
            color: #dc3545;
            font-weight: 600;
        }
        
        .projection-table .trip-name {
            color: #667eea;
            font-style: italic;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .edit-btn:hover {
            background: #138496;
        }
        
        /* Inline edit form */
        .edit-form-inline {
            background: #fff9e6;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .inline-form-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 2px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üíº Tori's PTO Advisor</h1>
            <p class="subtitle">Wyoming State Worker Edition</p>
            
            <!-- Step 1: Confirm Balance -->
            <div id="step1">
                <h3 style="color: #667eea; margin-bottom: 20px;">Step 1: Confirm Current PTO Balance</h3>
                <div class="form-group">
                    <label>Current PTO Balance</label>
                    <input type="text" id="currentBalance" value="73:20" placeholder="e.g., 73:20 or 73.33">
                    <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">Enter as "HH:MM" (73:20) or as decimal (73.33)</p>
                </div>
                <button onclick="confirmBalance()">Confirm Balance</button>
            </div>
            
            <!-- Step 2: Validate Planned PTO -->
            <div id="step2" class="hidden">
                <div class="balance-display">
                    <h2 id="displayBalance">73:20</h2>
                    <p>Current PTO Balance</p>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Step 2: Review Planned PTO</h3>
                <div id="plannedTripsSection"></div>
                <button onclick="validatePlannedPTO()">Confirm All Trips Still Valid</button>
            </div>
            
            <!-- Step 3: Main Interface -->
            <div id="step3" class="hidden">
                <div class="balance-display" onclick="editBalance()" style="cursor: pointer;" title="Click to edit balance">
                    <h2 id="mainBalance">73:20</h2>
                    <p>Current PTO Balance (click to edit)</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="showPlanPTO()">üìÖ Plan New PTO</button>
                    <button onclick="showHolidays()" class="btn-secondary">üéâ View Holidays</button>
                </div>
                
                <button onclick="showProjections()" class="btn-success" style="margin-bottom: 20px;">üìä View Balance Projections</button>
                
                <!-- Plan PTO Card - inline above trips -->
                <div id="planPTOCard" class="inline-form-card hidden">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Plan New PTO</h3>
                    
                    <div class="form-group">
                        <label>PTO Type</label>
                        <select id="ptoType" onchange="toggleAdminHoursInput()">
                            <option value="pto">PTO (Vacation)</option>
                            <option value="admin">Admin Time (No Balance Impact)</option>
                            <option value="split">Split (Admin + PTO)</option>
                        </select>
                    </div>
                    
                    <div class="form-group hidden" id="adminHoursGroup">
                        <label>Admin Hours to Use</label>
                        <input type="number" id="adminHours" step="0.01" min="0" placeholder="e.g., 12">
                        <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">Remaining hours will be deducted from PTO</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate" onchange="syncEndDate()">
                    </div>
                    
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Destination / Purpose</label>
                        <input type="text" id="destination" placeholder="e.g., Hawaii vacation, Family visit">
                    </div>
                    
                    <div class="form-group">
                        <label>Reservations / Notes (optional)</label>
                        <textarea id="reservations" rows="3" placeholder="Flight info, hotel, etc."></textarea>
                    </div>
                    
                    <div id="ptoWarnings"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button onclick="savePlannedPTO()">Save PTO</button>
                        <button onclick="cancelPlanPTO()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
                
                <!-- Planned Trips Section -->
                <div id="plannedTripsMain">
                    <h3 style="color: #667eea; margin: 20px 0 12px 0; border-bottom: 2px solid #667eea; padding-bottom: 8px;">üóìÔ∏è Your Planned Trips</h3>
                    <div id="mainTripsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Holidays Modal -->
        <div id="holidaysCard" class="card hidden">
            <h3 style="color: #667eea; margin-bottom: 20px;">üéâ Wyoming State Holidays</h3>
            <div id="holidaysList"></div>
            <button onclick="hideHolidays()" class="btn-secondary" style="margin-top: 20px;">Close</button>
        </div>
        
        <!-- Projections Modal -->
        <div id="projectionsCard" class="card hidden">
            <h3 style="color: #667eea; margin-bottom: 20px;">üìä PTO Balance Projections</h3>
            <div id="projectionsList"></div>
            <button onclick="hideProjections()" class="btn-secondary" style="margin-top: 20px;">Close</button>
        </div>
    </div>
    
    <script>
        // Google Sheets Configuration
        const SPREADSHEET_ID = '107ByQVrvKaBV-IgB9WzSKJnTx5k-9m-VXNg6j25WEec';
        const SHEET_BALANCE = 'Balance';
        const SHEET_TRIPS = 'Trips';
        
        // Service Account Credentials
        const SERVICE_ACCOUNT = {
            client_email: "tori-pto-service@tori-pto-advisor.iam.gserviceaccount.com",
            private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCzCb9Z3IONbhi2\nMlP5OLTFyGmqpt0UZhggB3rZdn+myXle4qzJbDvqe4NcZMq0n+EMbY+UOQHzj4WE\nf1w0cYg0b6gLBTLbZXrJ446ab1pgCVbq9DuHEfIpfG3G07SkISj8rrbb0uFwiaA0\n5tcbBZ2nLdZYipAM0ujRyOsrFaiv4JUMk6vE9SuyyI3PVK6LCoPqb9iQyBlNYhPk\nB+1SL/KGjRVjkPEk68+x1w48BKcRMy0YN015V/eo45Oh2KRd3dV1ubJ4D7IcSzsg\nFGeVV+C//MrRLeOYEy1BaCaGKTT+VHtJeUt06robTyJaWJnZt7YSARRuJb3kxoRH\nJMy2bk0PAgMBAAECggEAAvwMHQ7ggIiPz+W54aMw3EUxgb9DWzYye8I0KZDgouKj\n69GCiN8NhqSldXJWsLkjksX2yUVEA4/mbWWEH3mvCBS+a+Sbyu1/pQLumyN1EbnG\nIaeNoHxLmaZx3Akmb0AAQ2oUMUjsKiiZK5iXiGNJFALfGl3A9f3EFM8xIGg9hiUE\nm1ePBPPXY2VItEG9Z8ry+AFHDreT7x/fekMXTfnpqFRLddE2ioucSshRzW7U+UAN\nOvt1V166PrUuIHtAveKaStTULzEPZS6By6viRpUIIDftvfgAptEFMLnpOC/QrZVo\n7tif6V36o03om42zQtrc6ygYwgD0Tj/sPa6kJHxQtQKBgQDrrmLZKbLKeK1A6ngC\niEWqKAd9NrUfbcbUIXEJVlAYbqEWQhJs10UJgWkqvnbgOmimX24YvKQrr4EV2Yan\nDTCtqeanRbMXpuSWCFjftp1RtmhKdrUQ4zIIgjD0ESbviRKWHJwdJiGxUZrkPvMV\n3nPeXRAWnAWmLeeNHYa15muEswKBgQDCeTdqkEdWgnkByIWVChEt5I+1c3d3TprB\nqWIm3i5vxTdho2METSWy/+XX1Qrtmb5YjUZCfD8xc7hLA2X41KNFsCVJwbYYWgIB\n9fKcB6nfeCsuexpcpjGh75R4nU39bUUOAUQbNlLu8h09pbF68nLguUXWUEJ3RWd2\nQl3O2FbcNQKBgBWjWB36Dxk5xSZdoJES89pwfGeJm018ZbHaNCeYThhAJ/gELu7h\nQMxjnkU3YXCqzCriPhh1UVlVbrOT2iICOwLmw29+HbhBMWF4+Lfpaz4yUhbsGSmo\nwlI3qcjuvjVlz1gK3mZqttMx29ey09yhJOA4iR6aSoZ8VnMFT/XpZtuzAoGBAI7O\n8PDiLmDKww2aMO43TFJFK3r15d7I7EAWoKsmMTeGvZqHnujDtlFyNVh/a9z7L5pb\ndCLSlp07+zOqtTE7BQLhzSASjiPnxN2nvJbz0bz2w88IO12Z9YyTIJZJ/cGCglk8\neMT66X/qb6qbiG9epxl7NFui6IwpfUaMidKhb3eZAoGAEmcmFmtljyUU1NOvbtgM\nIrFA0QlDalsJD/HSZsslCrrwsHpgX6oxhyg425wgmFcC8MiBRkqyMJMPouxqKToo\njIfXjTWVU3pF89QW+MRN0gCHsLppH/rXMFgU7liCuCIw94NqJ3xKS7bnsuGbYKey\nSVB5YETSRSvhZb6+LKJFgH4=\n-----END PRIVATE KEY-----\n"
        };
        
        // State
        let state = {
            currentBalance: 73.33,
            plannedTrips: [],
            lastUpdated: new Date().toISOString()
        };
        
        let accessToken = null;
        let editingIndex = -1;
        let originalTrip = null;

        // =====================================================
        // FIX: Parse date strings as LOCAL time, not UTC.
        // "2026-06-23" parsed with new Date() = UTC midnight,
        // which in Mountain Time (UTC-6/7) displays as June 22.
        // This helper adds T00:00:00 to force local interpretation.
        // =====================================================
        function parseLocalDate(dateStr) {
            if (!dateStr) return new Date();
            // Append local midnight time so JS doesn't shift to UTC
            return new Date(dateStr + 'T00:00:00');
        }

        // Format a stored date string (YYYY-MM-DD) for display
        function formatDateForDisplay(dateStr, options) {
            return parseLocalDate(dateStr).toLocaleDateString('en-US', options);
        }
        
        // Get emoji for trip destination
        function getEmojiForDestination(destination) {
            const lower = destination.toLowerCase();
            if (lower.includes('camp')) return '‚õ∫';
            if (lower.includes('cruise')) return 'üö¢';
            if (lower.includes('family') || lower.includes('visit')) return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            if (lower.includes('shop')) return 'üõçÔ∏è';
            if (lower.includes('beach') || lower.includes('hawaii') || lower.includes('mexico')) return 'üèñÔ∏è';
            if (lower.includes('disney') || lower.includes('theme park')) return 'üé¢';
            if (lower.includes('mountain') || lower.includes('ski')) return '‚õ∞Ô∏è';
            return '‚úàÔ∏è';
        }
        
        // Sync end date to start date
        function syncEndDate() {
            const startDate = document.getElementById('startDate').value;
            if (startDate) {
                document.getElementById('endDate').value = startDate;
            }
        }
        
        // Get OAuth access token
        async function getAccessToken() {
            if (accessToken) return accessToken;
            
            const header = { alg: 'RS256', typ: 'JWT' };
            const now = Math.floor(Date.now() / 1000);
            const claim = {
                iss: SERVICE_ACCOUNT.client_email,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                aud: 'https://oauth2.googleapis.com/token',
                exp: now + 3600,
                iat: now
            };
            
            const base64Header = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const base64Claim = btoa(JSON.stringify(claim)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            const pemHeader = "-----BEGIN PRIVATE KEY-----";
            const pemFooter = "-----END PRIVATE KEY-----";
            const pemContents = SERVICE_ACCOUNT.private_key.substring(
                pemHeader.length,
                SERVICE_ACCOUNT.private_key.length - pemFooter.length - 1
            ).replace(/\s/g, '');
            
            const binaryKey = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
            const cryptoKey = await crypto.subtle.importKey(
                'pkcs8', binaryKey,
                { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
                false, ['sign']
            );
            
            const signatureData = new TextEncoder().encode(`${base64Header}.${base64Claim}`);
            const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', cryptoKey, signatureData);
            const base64Signature = btoa(String.fromCharCode(...new Uint8Array(signature)))
                .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            const jwt = `${base64Header}.${base64Claim}.${base64Signature}`;
            
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
            });
            
            const data = await response.json();
            accessToken = data.access_token;
            setTimeout(() => { accessToken = null; }, 3500 * 1000);
            
            return accessToken;
        }
        
        // Load state from Google Sheets
        async function loadState() {
            try {
                const token = await getAccessToken();
                
                const balanceResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_BALANCE}!B1`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const balanceData = await balanceResponse.json();
                
                if (balanceData.values && balanceData.values[0] && balanceData.values[0][0]) {
                    state.currentBalance = parseFloat(balanceData.values[0][0]);
                }
                
                const tripsResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2:K1000`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const tripsData = await tripsResponse.json();
                
                state.plannedTrips = [];
                if (tripsData.values && tripsData.values.length > 0) {
                    state.plannedTrips = tripsData.values
                        .filter(row => row[0])
                        .map(row => ({
                            type: row[0],
                            startDate: row[1],
                            endDate: row[2],
                            destination: row[3],
                            reservations: row[4] || '',
                            daysUsed: parseInt(row[5]) || 0,
                            hoursUsed: parseFloat(row[6]) || 0,
                            projectedBalance: parseFloat(row[7]) || 0,
                            balanceAfter: parseFloat(row[8]) || 0,
                            adminHours: parseFloat(row[9]) || 0,
                            ptoHours: parseFloat(row[10]) || 0
                        }));
                }
                
                console.log('‚úì Loaded from Google Sheets');
            } catch (error) {
                console.error('Error loading:', error);
            }
        }
        
        // Save state to Google Sheets
        async function saveState() {
            try {
                const token = await getAccessToken();
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_BALANCE}!B1?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values: [[state.currentBalance]] })
                    }
                );
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2:K1000:clear`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    }
                );
                
                if (state.plannedTrips.length > 0) {
                    const tripRows = state.plannedTrips.map(trip => [
                        trip.type,
                        trip.startDate,
                        trip.endDate,
                        trip.destination,
                        trip.reservations || '',
                        trip.daysUsed,
                        trip.hoursUsed,
                        trip.projectedBalance,
                        trip.balanceAfter,
                        trip.adminHours || 0,
                        trip.ptoHours || 0
                    ]);
                    
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ values: tripRows })
                        }
                    );
                }
                
                console.log('‚úì Saved to Google Sheets');
            } catch (error) {
                console.error('Error saving:', error);
            }
        }
        
        // Format hours to "HH:MM"
        function formatHours(hours) {
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            return `${wholeHours}:${minutes.toString().padStart(2, '0')}`;
        }
        
        // Parse user input
        function parseHoursInput(input) {
            if (!input) return null;
            input = input.trim();
            
            const colonMatch = input.match(/(\d+):(\d+)/);
            if (colonMatch) {
                const hours = parseInt(colonMatch[1]);
                const minutes = parseInt(colonMatch[2]);
                return hours + (minutes / 60);
            }
            
            const decimal = parseFloat(input);
            if (!isNaN(decimal)) return decimal;
            
            return null;
        }
        
        // Wyoming State Holidays
        function getHolidays(year) {
            const holidays = [];
            
            const observeWeekend = (date) => {
                const day = date.getDay();
                if (day === 6) date.setDate(date.getDate() - 1);
                else if (day === 0) date.setDate(date.getDate() + 1);
                return date;
            };
            
            holidays.push({ name: "New Year's Day", date: observeWeekend(new Date(year, 0, 1)) });
            
            const mlkDay = new Date(year, 0, 1);
            mlkDay.setDate(1 + (7 - mlkDay.getDay() + 1) % 7 + 14);
            holidays.push({ name: "MLK / Wyoming Equality Day", date: mlkDay });
            
            const presDay = new Date(year, 1, 1);
            presDay.setDate(1 + (7 - presDay.getDay() + 1) % 7 + 14);
            holidays.push({ name: "President's Day", date: presDay });
            
            const memDay = new Date(year, 4, 31);
            memDay.setDate(31 - (memDay.getDay() + 6) % 7);
            holidays.push({ name: "Memorial Day", date: memDay });
            
            holidays.push({ name: "Independence Day", date: observeWeekend(new Date(year, 6, 4)) });
            
            const laborDay = new Date(year, 8, 1);
            laborDay.setDate(1 + (7 - laborDay.getDay() + 1) % 7);
            holidays.push({ name: "Labor Day", date: laborDay });
            
            holidays.push({ name: "Veterans Day", date: observeWeekend(new Date(year, 10, 11)) });
            
            const thanksgiving = new Date(year, 10, 1);
            thanksgiving.setDate(1 + (7 - thanksgiving.getDay() + 4) % 7 + 21);
            holidays.push({ name: "Thanksgiving", date: thanksgiving });
            
            holidays.push({ name: "Christmas", date: observeWeekend(new Date(year, 11, 25)) });
            
            return holidays;
        }
        
        // Count weekdays - FIX: use parseLocalDate to avoid timezone shift
        function countWeekdays(startDate, endDate) {
            let count = 0;
            let current = parseLocalDate(startDate);
            const end = parseLocalDate(endDate);
            
            while (current <= end) {
                const day = current.getDay();
                if (day !== 0 && day !== 6) count++;
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }
        
        // Get monthly accrual
        function getMonthlyAccrual(date) {
            const checkDate = new Date(date);
            const may2027 = new Date(2027, 4, 1);
            
            if (checkDate < may2027) return 10;
            
            const yearsSince2027 = checkDate.getFullYear() - 2027;
            const cyclesPassed = Math.floor(yearsSince2027 / 4);
            return 10 + (cyclesPassed + 1) * 2;
        }
        
        // Check holiday proximity - FIX: use parseLocalDate
        function checkHolidayProximity(startDate, endDate) {
            const start = parseLocalDate(startDate);
            const end = parseLocalDate(endDate);
            const warnings = [];
            
            const year = start.getFullYear();
            const holidays = [...getHolidays(year), ...getHolidays(year + 1)];
            
            holidays.forEach(holiday => {
                const holidayDate = holiday.date;
                const twoWeeksBefore = new Date(holidayDate);
                twoWeeksBefore.setDate(twoWeeksBefore.getDate() - 14);
                const twoWeeksAfter = new Date(holidayDate);
                twoWeeksAfter.setDate(twoWeeksAfter.getDate() + 14);
                
                if ((start >= twoWeeksBefore && start <= twoWeeksAfter) ||
                    (end >= twoWeeksBefore && end <= twoWeeksAfter)) {
                    
                    if (holidayDate >= start && holidayDate <= end) {
                        warnings.push({
                            type: 'info',
                            message: `‚úì Your PTO includes ${holiday.name} (${holidayDate.toLocaleDateString()}) - Great planning!`
                        });
                    } else {
                        warnings.push({
                            type: 'warning',
                            message: `‚ö†Ô∏è ${holiday.name} is on ${holidayDate.toLocaleDateString()}. Consider adjusting your dates to include this holiday!`
                        });
                    }
                }
            });
            
            return warnings;
        }
        
        // Get projected balance
        function getProjectedBalance(targetDate) {
            const today = new Date();
            const target = parseLocalDate(targetDate);
            let balance = state.currentBalance;
            
            let current = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            
            while (current <= target) {
                const accrual = getMonthlyAccrual(current);
                balance += accrual;
                if (balance > 400) balance = 400;
                current.setMonth(current.getMonth() + 1);
            }
            
            return balance;
        }
        
        // Get PTO between dates
        function getPTOBetween(startDate, endDate) {
            return state.plannedTrips.filter(trip => {
                const tripStart = parseLocalDate(trip.startDate);
                return tripStart >= startDate && tripStart <= endDate;
            });
        }
        
        // Step 1: Confirm Balance
        function confirmBalance() {
            const input = document.getElementById('currentBalance').value;
            const balance = parseHoursInput(input);
            
            if (balance === null || balance < 0) {
                alert('Please enter a valid PTO balance');
                return;
            }
            
            if (balance > 400) {
                alert('Balance cannot exceed 400 hours');
                return;
            }
            
            state.currentBalance = balance;
            saveState();
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('displayBalance').textContent = formatHours(balance);
            
            displayPlannedTrips();
        }
        
        // Display planned trips for validation - FIX: use formatDateForDisplay
        function displayPlannedTrips() {
            const section = document.getElementById('plannedTripsSection');
            
            if (state.plannedTrips.length === 0) {
                section.innerHTML = '<p style="color: #666; margin-bottom: 20px;">No planned PTO yet.</p>';
            } else {
                let html = '';
                state.plannedTrips.forEach((trip, idx) => {
                    const dateRange = `${formatDateForDisplay(trip.startDate, { month: 'short', day: 'numeric' })} - ${formatDateForDisplay(trip.endDate, { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    const emoji = getEmojiForDestination(trip.destination);
                    
                    html += `
                        <div class="trip-card ${trip.type === 'admin' ? 'admin' : ''}">
                            <div class="trip-main-line">
                                <span class="trip-emoji">${emoji}</span> ${trip.destination}
                                <span class="trip-divider">‚Ä¢</span> ${dateRange}
                                <span class="trip-divider">‚Ä¢</span> ${formatHours(trip.hoursUsed)}
                            </div>
                            <div class="trip-actions">
                                <button class="edit-btn" onclick="modifyTrip(${idx})">‚úèÔ∏è</button>
                                <button class="delete-btn" onclick="deletePlannedTrip(${idx})">üóëÔ∏è</button>
                            </div>
                            ${trip.reservations ? `<div class="trip-notes-compact">üìù ${trip.reservations}</div>` : ''}
                            ${trip.type !== 'admin' ? `<div class="trip-balance-compact">After: ${formatHours(trip.balanceAfter)}</div>` : ''}
                        </div>
                    `;
                });
                section.innerHTML = html;
            }
        }
        
        // Modify trip (from validation screen)
        function modifyTrip(idx) {
            const trip = state.plannedTrips[idx];
            
            document.getElementById('ptoType').value = trip.type;
            document.getElementById('startDate').value = trip.startDate;
            document.getElementById('endDate').value = trip.endDate;
            document.getElementById('destination').value = trip.destination;
            document.getElementById('reservations').value = trip.reservations || '';
            
            if (trip.type === 'split') {
                document.getElementById('adminHours').value = trip.adminHours || 0;
                toggleAdminHoursInput();
            }
            
            state.plannedTrips.splice(idx, 1);
            saveState();
            
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            updateMainBalance();
            displayMainTrips();
            showPlanPTO();
        }
        
        // Delete planned trip
        function deletePlannedTrip(idx) {
            if (confirm('Cancel this trip?')) {
                state.plannedTrips.splice(idx, 1);
                saveState();
                displayPlannedTrips();
            }
        }
        
        // Validate planned PTO
        function validatePlannedPTO() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            updateMainBalance();
            displayMainTrips();
        }
        
        // Display main trips - FIX: use formatDateForDisplay
        function displayMainTrips(editIdx = -1, editFormHtml = '') {
            const container = document.getElementById('mainTripsList');
            
            if (state.plannedTrips.length === 0) {
                container.innerHTML = '<div class="no-trips">No trips planned yet. Click "Plan New PTO" to get started!</div>';
                return;
            }
            
            let html = '';
            state.plannedTrips.forEach((trip, idx) => {
                if (editIdx === idx && editFormHtml) {
                    html += editFormHtml;
                }
                
                // FIX: Use formatDateForDisplay instead of new Date(trip.startDate)
                const dateStr = trip.startDate === trip.endDate
                    ? formatDateForDisplay(trip.startDate, { month: 'short', day: 'numeric' })
                    : `${formatDateForDisplay(trip.startDate, { month: 'short', day: 'numeric' })}-${formatDateForDisplay(trip.endDate, { month: 'short', day: 'numeric' })}`;
                
                const emoji = getEmojiForDestination(trip.destination);
                const isAdmin = trip.type === 'admin';
                
                let mainLine = `<span class="trip-emoji">${emoji}</span> ${trip.destination}`;
                mainLine += ` <span class="trip-divider">‚Ä¢</span> ${dateStr}`;
                mainLine += ` <span class="trip-divider">‚Ä¢</span> ${formatHours(trip.hoursUsed)}`;
                if (isAdmin) mainLine += ' (Admin)';
                
                html += `
                    <div class="trip-card ${isAdmin ? 'admin' : ''}">
                        <div class="trip-main-line">${mainLine}</div>
                        <div class="trip-actions">
                            <button class="edit-btn" onclick="editMainTrip(${idx})">‚úèÔ∏è</button>
                            <button class="delete-btn" onclick="deleteMainTrip(${idx})">üóëÔ∏è</button>
                        </div>
                        ${trip.reservations ? `<div class="trip-notes-compact">üìù ${trip.reservations}</div>` : ''}
                        ${!isAdmin ? `<div class="trip-balance-compact">After: ${formatHours(trip.balanceAfter)}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Edit trip inline
        function editMainTrip(idx) {
            const trip = state.plannedTrips[idx];
            editingIndex = idx;
            originalTrip = JSON.parse(JSON.stringify(trip));
            
            let formHtml = `
                <div class="edit-form-inline" id="inlineEditForm">
                    <h3 style="color: #17a2b8; margin-bottom: 15px;">‚úèÔ∏è Edit Trip</h3>
                    
                    <div class="form-group">
                        <label>PTO Type</label>
                        <select id="ptoTypeEdit" onchange="toggleAdminHoursInputEdit()">
                            <option value="pto" ${trip.type === 'pto' ? 'selected' : ''}>PTO (Vacation)</option>
                            <option value="admin" ${trip.type === 'admin' ? 'selected' : ''}>Admin Time</option>
                            <option value="split" ${trip.type === 'split' ? 'selected' : ''}>Split</option>
                        </select>
                    </div>
                    
                    <div class="form-group ${trip.type !== 'split' ? 'hidden' : ''}" id="adminHoursGroupEdit">
                        <label>Admin Hours</label>
                        <input type="number" id="adminHoursEdit" step="0.01" value="${trip.adminHours || 0}">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="startDateEdit" value="${trip.startDate}">
                    </div>
                    
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="endDateEdit" value="${trip.endDate}">
                    </div>
                    
                    <div class="form-group">
                        <label>Destination</label>
                        <input type="text" id="destinationEdit" value="${trip.destination}">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="reservationsEdit" rows="2">${trip.reservations || ''}</textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button onclick="saveEditedTrip()" style="background: #17a2b8;">Save</button>
                        <button onclick="cancelEdit()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            `;
            
            displayMainTrips(idx, formHtml);
            document.getElementById('inlineEditForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function toggleAdminHoursInputEdit() {
            const type = document.getElementById('ptoTypeEdit').value;
            const group = document.getElementById('adminHoursGroupEdit');
            if (type === 'split') group.classList.remove('hidden');
            else group.classList.add('hidden');
        }
        
        // Cancel edit - restore original trip
        function cancelEdit() {
            if (originalTrip !== null) {
                state.plannedTrips[editingIndex] = originalTrip;
            }
            editingIndex = -1;
            originalTrip = null;
            displayMainTrips();
        }
        
        function saveEditedTrip() {
            const type = document.getElementById('ptoTypeEdit').value;
            const startDate = document.getElementById('startDateEdit').value;
            const endDate = document.getElementById('endDateEdit').value;
            const destination = document.getElementById('destinationEdit').value;
            const reservations = document.getElementById('reservationsEdit').value;
            const adminHours = type === 'split' ? parseFloat(document.getElementById('adminHoursEdit').value) || 0 : 0;
            
            if (!startDate || !endDate || !destination) {
                alert('Please fill in all fields');
                return;
            }
            
            const daysUsed = countWeekdays(startDate, endDate);
            const totalHours = daysUsed * 8;
            const ptoHours = type === 'split' ? totalHours - adminHours : totalHours;
            
            const projectedBalance = getProjectedBalance(startDate);
            const today = new Date();
            const tripStart = parseLocalDate(startDate);
            const priorTrips = getPTOBetween(today, tripStart);
            let priorPTOUsed = 0;
            priorTrips.forEach(trip => {
                if (trip.type === 'pto' || trip.type === 'split') {
                    priorPTOUsed += trip.ptoHours || trip.hoursUsed;
                }
            });
            
            const availableBalance = projectedBalance - priorPTOUsed;
            
            const trip = {
                type,
                startDate,
                endDate,
                destination,
                reservations,
                daysUsed,
                hoursUsed: totalHours,
                adminHours: type === 'split' ? adminHours : 0,
                ptoHours: type === 'split' ? ptoHours : (type === 'pto' ? totalHours : 0),
                projectedBalance,
                balanceAfter: (type === 'pto' || type === 'split') ? availableBalance - ptoHours : availableBalance
            };
            
            state.plannedTrips[editingIndex] = trip;
            state.plannedTrips.sort((a, b) => parseLocalDate(a.startDate) - parseLocalDate(b.startDate));
            
            saveState();
            editingIndex = -1;
            originalTrip = null;
            displayMainTrips();
            
            alert('‚úÖ Trip updated');
        }
        
        // Delete main trip
        function deleteMainTrip(idx) {
            if (confirm('Delete this trip?')) {
                state.plannedTrips.splice(idx, 1);
                saveState();
                displayMainTrips();
            }
        }
        
        // Update main balance
        function updateMainBalance() {
            document.getElementById('mainBalance').textContent = formatHours(state.currentBalance);
        }
        
        // Edit balance
        function editBalance() {
            const newBalance = prompt(`Update PTO balance:\n\n(Current: ${formatHours(state.currentBalance)})\n\nEnter new balance:`, formatHours(state.currentBalance));
            
            if (newBalance === null) return;
            
            const parsed = parseHoursInput(newBalance);
            
            if (parsed === null || parsed < 0) {
                alert('Please enter a valid balance');
                return;
            }
            
            if (parsed > 400) {
                alert('Balance cannot exceed 400 hours');
                return;
            }
            
            state.currentBalance = parsed;
            saveState();
            updateMainBalance();
            alert(`‚úÖ Balance updated to ${formatHours(parsed)}`);
        }
        
        // Show plan PTO
        function showPlanPTO() {
            document.getElementById('planPTOCard').classList.remove('hidden');
            document.getElementById('ptoWarnings').innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            document.getElementById('endDate').min = today;
            
            document.getElementById('planPTOCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Toggle admin hours input
        function toggleAdminHoursInput() {
            const type = document.getElementById('ptoType').value;
            const group = document.getElementById('adminHoursGroup');
            
            if (type === 'split') group.classList.remove('hidden');
            else {
                group.classList.add('hidden');
                document.getElementById('adminHours').value = '';
            }
        }
        
        // Save planned PTO
        function savePlannedPTO() {
            const type = document.getElementById('ptoType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const destination = document.getElementById('destination').value;
            const reservations = document.getElementById('reservations').value;
            const adminHours = type === 'split' ? parseFloat(document.getElementById('adminHours').value) || 0 : 0;
            
            if (!startDate || !endDate || !destination) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (type === 'split' && adminHours <= 0) {
                alert('Please enter admin hours');
                return;
            }
            
            const daysUsed = countWeekdays(startDate, endDate);
            const totalHours = daysUsed * 8;
            
            if (type === 'split' && adminHours >= totalHours) {
                alert(`Admin hours must be less than total (${formatHours(totalHours)})`);
                return;
            }
            
            const ptoHours = type === 'split' ? totalHours - adminHours : totalHours;
            const projectedBalance = getProjectedBalance(startDate);
            
            const today = new Date();
            const tripStart = parseLocalDate(startDate);
            const priorTrips = getPTOBetween(today, tripStart);
            let priorPTOUsed = 0;
            priorTrips.forEach(trip => {
                if (trip.type === 'pto' || trip.type === 'split') {
                    priorPTOUsed += trip.ptoHours || trip.hoursUsed;
                }
            });
            
            const availableBalance = projectedBalance - priorPTOUsed;
            
            if ((type === 'pto' || type === 'split') && ptoHours > availableBalance) {
                alert(`Insufficient PTO.\n\nProjected: ${formatHours(projectedBalance)}\nPlanned: ${formatHours(priorPTOUsed)}\nAvailable: ${formatHours(availableBalance)}\nNeeded: ${formatHours(ptoHours)}\n\nShortfall: ${formatHours(ptoHours - availableBalance)}`);
                return;
            }
            
            const trip = {
                type,
                startDate,
                endDate,
                destination,
                reservations,
                daysUsed,
                hoursUsed: totalHours,
                adminHours: type === 'split' ? adminHours : 0,
                ptoHours: type === 'split' ? ptoHours : (type === 'pto' ? totalHours : 0),
                projectedBalance,
                balanceAfter: (type === 'pto' || type === 'split') ? availableBalance - ptoHours : availableBalance
            };
            
            state.plannedTrips.push(trip);
            state.plannedTrips.sort((a, b) => parseLocalDate(a.startDate) - parseLocalDate(b.startDate));
            
            saveState();
            cancelPlanPTO();
            displayMainTrips();
            
            if (type === 'admin') {
                alert('‚úÖ Admin time saved (no PTO impact)');
            } else {
                alert(`‚úÖ PTO saved\n\nProjected: ${formatHours(projectedBalance)}\nUsed: ${formatHours(ptoHours)}\nRemaining: ${formatHours(availableBalance - ptoHours)}`);
            }
        }
        
        // Cancel plan PTO
        function cancelPlanPTO() {
            document.getElementById('planPTOCard').classList.add('hidden');
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('reservations').value = '';
            document.getElementById('ptoType').value = 'pto';
            document.getElementById('adminHours').value = '';
            document.getElementById('adminHoursGroup').classList.add('hidden');
        }
        
        // Show holidays
        function showHolidays() {
            const currentYear = new Date().getFullYear();
            const holidays = [...getHolidays(currentYear), ...getHolidays(currentYear + 1), ...getHolidays(currentYear + 2)];
            
            let html = '<div class="holiday-list">';
            holidays.forEach(h => {
                html += `
                    <div class="holiday-item">
                        <strong>${h.name}</strong><br>
                        ${h.date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('holidaysList').innerHTML = html;
            document.getElementById('holidaysCard').classList.remove('hidden');
        }
        
        function hideHolidays() {
            document.getElementById('holidaysCard').classList.add('hidden');
        }
        
        // Show projections
        function showProjections() {
            let html = '<div class="projection">';
            html += '<h4>Current Balance</h4>';
            html += `<p><strong>${formatHours(state.currentBalance)}</strong> (${(state.currentBalance / 8).toFixed(1)} days)</p>`;
            html += '</div>';
            
            const projections = [];
            let runningBalance = state.currentBalance;
            const today = new Date();
            
            for (let i = 1; i <= 24; i++) {
                const projDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const accrual = getMonthlyAccrual(projDate);
                runningBalance += accrual;
                if (runningBalance > 400) runningBalance = 400;
                
                const monthStart = new Date(projDate.getFullYear(), projDate.getMonth(), 1);
                const monthEnd = new Date(projDate.getFullYear(), projDate.getMonth() + 1, 0);
                const tripsThisMonth = state.plannedTrips.filter(trip => {
                    const tripStart = parseLocalDate(trip.startDate);
                    return tripStart >= monthStart && tripStart <= monthEnd && (trip.type === 'pto' || trip.type === 'split');
                });
                
                let ptoUsed = 0;
                let tripNames = [];
                tripsThisMonth.forEach(trip => {
                    ptoUsed += trip.ptoHours || trip.hoursUsed;
                    tripNames.push(trip.destination);
                });
                
                runningBalance -= ptoUsed;
                
                projections.push({
                    month: projDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                    accrual,
                    ptoUsed,
                    tripNames,
                    balance: runningBalance,
                    hasPTO: ptoUsed > 0
                });
            }
            
            html += '<div class="projection">';
            html += '<h4>24-Month Projection</h4>';
            html += '<table class="projection-table">';
            html += '<tr><th>Month</th><th>Accrual</th><th>PTO Used</th><th>Balance</th><th>Days</th></tr>';
            
            projections.forEach(p => {
                const rowClass = p.hasPTO ? 'has-pto' : '';
                const ptoCell = p.ptoUsed > 0 
                    ? `<span class="pto-used">-${formatHours(p.ptoUsed)}</span><br><span class="trip-name">${p.tripNames.join(', ')}</span>`
                    : '-';
                
                html += `
                    <tr class="${rowClass}">
                        <td>${p.month}</td>
                        <td>+${formatHours(p.accrual)}</td>
                        <td>${ptoCell}</td>
                        <td><strong>${formatHours(p.balance)}</strong></td>
                        <td>${(p.balance / 8).toFixed(1)}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            html += '</div>';
            
            html += '<div class="alert alert-info">';
            html += '<strong>üìÖ Accrual Increase:</strong> Starting May 1, 2027, monthly accrual increases to 12 hrs/month. Increases every 4 years.';
            html += '</div>';
            
            const maxProjected = Math.max(...projections.map(p => p.balance));
            if (maxProjected >= 380) {
                html += '<div class="alert alert-warning">';
                html += '<strong>‚ö†Ô∏è Approaching Cap:</strong> You are approaching the 400-hour cap. Consider using PTO to avoid losing accrual.';
                html += '</div>';
            }
            
            document.getElementById('projectionsList').innerHTML = html;
            document.getElementById('projectionsCard').classList.remove('hidden');
        }
        
        function hideProjections() {
            document.getElementById('projectionsCard').classList.add('hidden');
        }
        
        // Initialize
        async function init() {
            await loadState();
            document.getElementById('currentBalance').value = formatHours(state.currentBalance);
        }
        
        init();
    </script>
</body>
</html>
