<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dan's PTO Advisor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c5f2d;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .balance-display {
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .balance-display h2 {
            font-size: 48px;
            margin-bottom: 5px;
        }
        
        .balance-display p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .balance-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .balance-item {
            font-size: 13px;
        }
        
        .balance-item strong {
            display: block;
            font-size: 18px;
            margin-top: 5px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c5f2d;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        .tori-holiday-highlight {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            color: #0c5460;
            font-size: 14px;
        }
        
        .trip-suggestion {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            color: #155724;
            font-size: 14px;
            font-weight: 500;
        }
        
        .trip-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 5px solid #2c5f2d;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .trip-card.non-pto {
            border-left-color: #6c757d;
        }
        
        .trip-card h4 {
            color: #2c5f2d;
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .trip-card.non-pto h4 {
            color: #6c757d;
        }
        
        .trip-card .trip-dates {
            font-size: 14px;
            color: #495057;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .trip-card .trip-detail {
            font-size: 13px;
            color: #6c757d;
            margin: 6px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .trip-card .trip-detail:before {
            content: "‚Ä¢";
            position: absolute;
            left: 8px;
            color: #2c5f2d;
        }
        
        .trip-card .trip-balance {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 13px;
            border: 1px solid #dee2e6;
        }
        
        .trip-card .trip-balance strong {
            color: #2c5f2d;
        }
        
        .trip-card .trip-notes {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 13px;
            border-left: 3px solid #ffc107;
            color: #495057;
        }
        
        .no-trips {
            text-align: center;
            padding: 40px;
            color: #adb5bd;
            font-style: italic;
        }
        
        .holiday-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .holiday-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .holiday-item strong {
            color: #2c5f2d;
        }
        
        .holiday-item.workday {
            border: 2px solid #ffc107;
            background: #fff3cd;
        }
        
        .hidden {
            display: none;
        }
        
        .projection {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .projection h4 {
            color: #2c5f2d;
            margin-bottom: 10px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .reserve-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .date-calc-display {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            border: 2px solid #17a2b8;
        }
        
        .date-calc-display strong {
            color: #2c5f2d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üèîÔ∏è Dan's PTO Advisor</h1>
            <p class="subtitle">Salary Employee - Day-Based Tracking</p>
            
            <!-- Step 1: Confirm Balance -->
            <div id="step1">
                <h3 style="color: #2c5f2d; margin-bottom: 20px;">Step 1: Confirm Current PTO Balance</h3>
                <div class="form-group">
                    <label>Current Planning Balance (days)</label>
                    <input type="number" id="currentBalance" step="0.5" value="22" placeholder="Enter planning balance">
                    <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">Enter as days (e.g., 22 or 18.5). You have 5 reserve days separate.</p>
                </div>
                <button onclick="confirmBalance()">Confirm Balance</button>
            </div>
            
            <!-- Step 2: Main Interface -->
            <div id="step2" class="hidden">
                <div class="balance-display" onclick="editBalance()" style="cursor: pointer;" title="Click to edit balance">
                    <h2 id="mainBalance">22 days</h2>
                    <p>Planning Balance (click to edit)</p>
                    <div class="balance-breakdown">
                        <div class="balance-item">
                            Planning Allowance
                            <strong id="planningDays">22 days</strong>
                        </div>
                        <div class="balance-item">
                            Reserve (Emergency)
                            <strong>5 days</strong>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="showPlanPTO()">üìÖ Plan PTO Days</button>
                    <button onclick="showPlanNonPTO()" class="btn-secondary">üóìÔ∏è Plan Non-PTO Day</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="showHolidays()" class="btn-warning">üéÑ View Holidays</button>
                    <button onclick="showProjections()" class="btn-success">üìä View Projections</button>
                </div>
                
                <!-- Planned Days Section -->
                <div id="plannedDaysMain">
                    <h3 style="color: #2c5f2d; margin: 20px 0 15px 0; border-bottom: 2px solid #2c5f2d; padding-bottom: 10px;">üóìÔ∏è Your Planned Days</h3>
                    <div id="mainDaysList"></div>
                </div>
            </div>
        </div>
        
        <!-- Plan PTO Modal -->
        <div id="planPTOCard" class="card hidden">
            <h3 style="color: #2c5f2d; margin-bottom: 20px;">Plan PTO Days</h3>
            
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="ptoStartDate" onchange="calculateWorkdays()">
            </div>
            
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="ptoEndDate" onchange="calculateWorkdays()">
            </div>
            
            <div id="workdayCalculation" class="hidden"></div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="toriComing" onchange="checkToriHolidays()">
                <label for="toriComing">Is Tori coming on this trip?</label>
            </div>
            
            <div id="toriHolidayWarnings"></div>
            
            <div class="form-group">
                <label>Purpose</label>
                <input type="text" id="ptoPurpose" placeholder="e.g., Family trip, Doctor appointment">
            </div>
            
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea id="ptoNotes" rows="3" placeholder="Additional details..."></textarea>
            </div>
            
            <div id="ptoWarnings"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="savePTO()">Save PTO</button>
                <button onclick="cancelPlanPTO()" class="btn-secondary">Cancel</button>
            </div>
        </div>
        
        <!-- Plan Non-PTO Modal -->
        <div id="planNonPTOCard" class="card hidden">
            <h3 style="color: #6c757d; margin-bottom: 20px;">Plan Non-PTO Day (Regular Day Off)</h3>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">Track what you're doing on your regular days off (Thu/Fri) - doesn't impact PTO balance</p>
            
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="nonPtoDate">
            </div>
            
            <div class="form-group">
                <label>Activity/Plans</label>
                <input type="text" id="nonPtoPurpose" placeholder="e.g., Hunting trip, Bike ride, Errands">
            </div>
            
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea id="nonPtoNotes" rows="3" placeholder="Additional details..."></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button onclick="saveNonPTO()" class="btn-secondary">Save Day</button>
                <button onclick="cancelPlanNonPTO()" class="btn-secondary">Cancel</button>
            </div>
        </div>
        
        <!-- Holidays Modal -->
        <div id="holidaysCard" class="card hidden">
            <h3 style="color: #2c5f2d; margin-bottom: 20px;">üéÑ Paid Holidays & Workday Check</h3>
            <div id="holidaysList"></div>
            <button onclick="hideHolidays()" class="btn-secondary" style="margin-top: 20px;">Close</button>
        </div>
        
        <!-- Projections Modal -->
        <div id="projectionsCard" class="card hidden">
            <h3 style="color: #2c5f2d; margin-bottom: 20px;">üìä PTO Balance Projections</h3>
            <div id="projectionsList"></div>
            <button onclick="hideProjections()" class="btn-secondary" style="margin-top: 20px;">Close</button>
        </div>
    </div>
    
    <script>
        // Google Sheets Configuration
        const SPREADSHEET_ID = '107ByQVrvKaBV-IgB9WzSKJnTx5k-9m-VXNg6j25WEec';
        const SHEET_BALANCE = 'Dan_Balance';
        const SHEET_TRIPS = 'Dan_Trips';
        
        // Service Account Credentials
        const SERVICE_ACCOUNT = {
            client_email: "tori-pto-service@tori-pto-advisor.iam.gserviceaccount.com",
            private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCzCb9Z3IONbhi2\nMlP5OLTFyGmqpt0UZhggB3rZdn+myXle4qzJbDvqe4NcZMq0n+EMbY+UOQHzj4WE\nf1w0cYg0b6gLBTLbZXrJ446ab1pgCVbq9DuHEfIpfG3G07SkISj8rrbb0uFwiaA0\n5tcbBZ2nLdZYipAM0ujRyOsrFaiv4JUMk6vE9SuyyI3PVK6LCoPqb9iQyBlNYhPk\nB+1SL/KGjRVjkPEk68+x1w48BKcRMy0YN015V/eo45Oh2KRd3dV1ubJ4D7IcSzsg\nFGeVV+C//MrRLeOYEy1BaCaGKTT+VHtJeUt06robTyJaWJnZt7YSARRuJb3kxoRH\nJMy2bk0PAgMBAAECggEAAvwMHQ7ggIiPz+W54aMw3EUxgb9DWzYye8I0KZDgouKj\n69GCiN8NhqSldXJWsLkjksX2yUVEA4/mbWWEH3mvCBS+a+Sbyu1/pQLumyN1EbnG\nIaeNoHxLmaZx3Akmb0AAQ2oUMUjsKiiZK5iXiGNJFALfGl3A9f3EFM8xIGg9hiUE\nm1ePBPPXY2VItEG9Z8ry+AFHDreT7x/fekMXTfnpqFRLddE2ioucSshRzW7U+UAN\nOvt1V166PrUuIHtAveKaStTULzEPZS6By6viRpUIIDftvfgAptEFMLnpOC/QrZVo\n7tif6V36o03om42zQtrc6ygYwgD0Tj/sPa6kJHxQtQKBgQDrrmLZKbLKeK1A6ngC\niEWqKAd9NrUfbcbUIXEJVlAYbqEWQhJs10UJgWkqvnbgOmimX24YvKQrr4EV2Yan\nDTCtqeanRbMXpuSWCFjftp1RtmhKdrUQ4zIIgjD0ESbviRKWHJwdJiGxUZrkPvMV\n3nPeXRAWnAWmLeeNHYa15muEswKBgQDCeTdqkEdWgnkByIWVChEt5I+1c3d3TprB\nqWIm3i5vxTdho2METSWy/+XX1Qrtmb5YjUZCfD8xc7hLA2X41KNFsCVJwbYYWgIB\n9fKcB6nfeCsuexpcpjGh75R4nU39bUUOAUQbNlLu8h09pbF68nLguUXWUEJ3RWd2\nQl3O2FbcNQKBgBWjWB36Dxk5xSZdoJES89pwfGeJm018ZbHaNCeYThhAJ/gELu7h\nQMxjnkU3YXCqzCriPhh1UVlVbrOT2iICOwLmw29+HbhBMWF4+Lfpaz4yUhbsGSmo\nwlI3qcjuvjVlz1gK3mZqttMx29ey09yhJOA4iR6aSoZ8VnMFT/XpZtuzAoGBAI7O\n8PDiLmDKww2aMO43TFJFK3r15d7I7EAWoKsmMTeGvZqHnujDtlFyNVh/a9z7L5pb\ndCLSlp07+zOqtTE7BQLhzSASjiPnxN2nvJbz0bz2w88IO12Z9YyTIJZJ/cGCglk8\neMT66X/qb6qbiG9epxl7NFui6IwpfUaMidKhb3eZAoGAEmcmFmtljyUU1NOvbtgM\nIrFA0QlDalsJD/HSZsslCrrwsHpgX6oxhyg425wgmFcC8MiBRkqyMJMPouxqKToo\njIfXjTWVU3pF89QW+MRN0gCHsLppH/rXMFgU7liCuCIw94NqJ3xKS7bnsuGbYKey\nSVB5YETSRSvhZb6+LKJFgH4=\n-----END PRIVATE KEY-----\n"
        };
        
        // Wyoming State Holidays (Tori's holidays)
        const WYOMING_HOLIDAYS = [
            { name: "New Year's Day", month: 0, day: 1 },
            { name: "Martin Luther King Jr. Day", month: 0, nthDay: 3, weekday: 1 }, // 3rd Monday of January
            { name: "Presidents' Day", month: 1, nthDay: 3, weekday: 1 }, // 3rd Monday of February
            { name: "Memorial Day", month: 4, lastWeekday: 1 }, // Last Monday of May
            { name: "Independence Day", month: 6, day: 4 },
            { name: "Labor Day", month: 8, nthDay: 1, weekday: 1 }, // 1st Monday of September
            { name: "Veterans Day", month: 10, day: 11 },
            { name: "Thanksgiving", month: 10, nthDay: 4, weekday: 4 }, // 4th Thursday of November
            { name: "Christmas", month: 11, day: 25 }
        ];
        
        // State
        let state = {
            currentBalance: 22,
            reserveDays: 5,
            reserveUsedThisYear: 0,
            plannedDays: [],
            lastUpdated: new Date().toISOString()
        };
        
        let accessToken = null;
        let calculatedWorkdays = 0;
        
        // Work schedule - Dan works Sat/Sun/Mon
        const WORK_DAYS = [0, 1, 6]; // Sunday=0, Monday=1, Saturday=6
        
        // Get observed holiday date (Saturday‚ÜíFriday, Sunday‚ÜíMonday)
        function getObservedHolidayDate(year, holiday) {
            let date;
            
            if (holiday.day) {
                // Fixed date holiday
                date = new Date(year, holiday.month, holiday.day);
            } else if (holiday.nthDay) {
                // Nth weekday of month
                date = new Date(year, holiday.month, 1);
                let count = 0;
                while (count < holiday.nthDay) {
                    if (date.getDay() === holiday.weekday) {
                        count++;
                    }
                    if (count < holiday.nthDay) {
                        date.setDate(date.getDate() + 1);
                    }
                }
            } else if (holiday.lastWeekday) {
                // Last weekday of month
                date = new Date(year, holiday.month + 1, 0); // Last day of month
                while (date.getDay() !== holiday.weekday) {
                    date.setDate(date.getDate() - 1);
                }
            }
            
            // Apply observance rules
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 6) { // Saturday ‚Üí observe Friday
                date.setDate(date.getDate() - 1);
            } else if (dayOfWeek === 0) { // Sunday ‚Üí observe Monday
                date.setDate(date.getDate() + 1);
            }
            
            return date;
        }
        
        // Get Tori holidays within 2 weeks of date range
        function getToriHolidaysNear(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            
            // Check 2 weeks before and after
            const twoWeeksBefore = new Date(startDate);
            twoWeeksBefore.setDate(twoWeeksBefore.getDate() - 14);
            const twoWeeksAfter = new Date(endDate);
            twoWeeksAfter.setDate(twoWeeksAfter.getDate() + 14);
            
            const nearbyHolidays = [];
            const years = [startDate.getFullYear(), endDate.getFullYear()];
            
            [...new Set(years)].forEach(year => {
                WYOMING_HOLIDAYS.forEach(holiday => {
                    const holidayDate = getObservedHolidayDate(year, holiday);
                    
                    // Only include if within 2-week window but NOT during the trip
                    if (holidayDate >= twoWeeksBefore && holidayDate <= twoWeeksAfter) {
                        if (holidayDate < startDate || holidayDate > endDate) {
                            const daysDiff = holidayDate < startDate 
                                ? Math.ceil((startDate - holidayDate) / (1000 * 60 * 60 * 24))
                                : Math.ceil((holidayDate - endDate) / (1000 * 60 * 60 * 24));
                            
                            nearbyHolidays.push({
                                name: holiday.name,
                                date: holidayDate,
                                daysBefore: holidayDate < startDate ? daysDiff : 0,
                                daysAfter: holidayDate > endDate ? daysDiff : 0
                            });
                        }
                    }
                });
            });
            
            return nearbyHolidays;
        }
        
        // Check Tori holidays and display suggestions
        function checkToriHolidays() {
            const startDate = document.getElementById('ptoStartDate').value;
            const endDate = document.getElementById('ptoEndDate').value;
            const toriComing = document.getElementById('toriComing').checked;
            const warningsDiv = document.getElementById('toriHolidayWarnings');
            
            if (!toriComing || !startDate || !endDate) {
                warningsDiv.innerHTML = '';
                return;
            }
            
            const nearbyHolidays = getToriHolidaysNear(startDate, endDate);
            
            if (nearbyHolidays.length === 0) {
                warningsDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            nearbyHolidays.forEach(h => {
                const dateStr = h.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                
                if (h.daysBefore > 0) {
                    html += `
                        <div class="tori-holiday-highlight">
                            üìÖ <strong>${h.name}</strong> is ${h.daysBefore} day${h.daysBefore !== 1 ? 's' : ''} before trip (${dateStr})
                        </div>
                        <div class="trip-suggestion">
                            üí° <strong>Suggestion:</strong> Start trip on ${dateStr} to save Tori ${h.daysBefore} day${h.daysBefore !== 1 ? 's' : ''} of PTO
                        </div>
                    `;
                } else if (h.daysAfter > 0) {
                    html += `
                        <div class="tori-holiday-highlight">
                            üìÖ <strong>${h.name}</strong> is ${h.daysAfter} day${h.daysAfter !== 1 ? 's' : ''} after trip (${dateStr})
                        </div>
                        <div class="trip-suggestion">
                            üí° <strong>Suggestion:</strong> End trip on ${dateStr} to save Tori ${h.daysAfter} day${h.daysAfter !== 1 ? 's' : ''} of PTO
                        </div>
                    `;
                }
            });
            
            warningsDiv.innerHTML = html;
        }
        
        // Get OAuth access token
        async function getAccessToken() {
            if (accessToken) return accessToken;
            
            const header = { alg: 'RS256', typ: 'JWT' };
            const now = Math.floor(Date.now() / 1000);
            const claim = {
                iss: SERVICE_ACCOUNT.client_email,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                aud: 'https://oauth2.googleapis.com/token',
                exp: now + 3600,
                iat: now
            };
            
            const base64Header = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const base64Claim = btoa(JSON.stringify(claim)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            const pemHeader = "-----BEGIN PRIVATE KEY-----";
            const pemFooter = "-----END PRIVATE KEY-----";
            const pemContents = SERVICE_ACCOUNT.private_key.substring(
                pemHeader.length,
                SERVICE_ACCOUNT.private_key.length - pemFooter.length - 1
            ).replace(/\s/g, '');
            
            const binaryKey = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
            const cryptoKey = await crypto.subtle.importKey(
                'pkcs8', binaryKey,
                { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
                false, ['sign']
            );
            
            const signatureData = new TextEncoder().encode(`${base64Header}.${base64Claim}`);
            const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', cryptoKey, signatureData);
            const base64Signature = btoa(String.fromCharCode(...new Uint8Array(signature)))
                .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            const jwt = `${base64Header}.${base64Claim}.${base64Signature}`;
            
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
            });
            
            const data = await response.json();
            accessToken = data.access_token;
            setTimeout(() => { accessToken = null; }, 3500 * 1000);
            
            return accessToken;
        }
        
        // Load state from Google Sheets
        async function loadState() {
            try {
                const token = await getAccessToken();
                
                const balanceResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_BALANCE}!B1`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const balanceData = await balanceResponse.json();
                
                if (balanceData.values && balanceData.values[0] && balanceData.values[0][0]) {
                    state.currentBalance = parseFloat(balanceData.values[0][0]);
                }
                
                const tripsResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2:J1000`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const tripsData = await tripsResponse.json();
                
                state.plannedDays = [];
                if (tripsData.values && tripsData.values.length > 0) {
                    state.plannedDays = tripsData.values
                        .filter(row => row[0])
                        .map(row => ({
                            type: row[0],
                            startDate: row[1],
                            endDate: row[2] || row[1],
                            purpose: row[3],
                            notes: row[4] || '',
                            daysUsed: parseFloat(row[5]) || 0,
                            balanceAfter: parseFloat(row[6]) || 0,
                            usesReserve: row[7] === 'true',
                            reserveDaysUsed: parseFloat(row[8]) || 0,
                            toriComing: row[9] === 'true'
                        }));
                }
                
                console.log('‚úì Loaded from Google Sheets');
            } catch (error) {
                console.error('Error loading:', error);
            }
        }
        
        // Save state to Google Sheets
        async function saveState() {
            try {
                const token = await getAccessToken();
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_BALANCE}!B1?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values: [[state.currentBalance]] })
                    }
                );
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2:J1000:clear`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    }
                );
                
                if (state.plannedDays.length > 0) {
                    const rows = state.plannedDays.map(day => [
                        day.type,
                        day.startDate,
                        day.endDate || day.startDate,
                        day.purpose,
                        day.notes || '',
                        day.daysUsed,
                        day.balanceAfter,
                        day.usesReserve ? 'true' : 'false',
                        day.reserveDaysUsed || 0,
                        day.toriComing ? 'true' : 'false'
                    ]);
                    
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ values: rows })
                        }
                    );
                }
                
                console.log('‚úì Saved to Google Sheets');
            } catch (error) {
                console.error('Error saving:', error);
            }
        }
        
        // Format days
        function formatDays(days) {
            if (days === Math.floor(days)) {
                return `${days} ${days === 1 ? 'day' : 'days'}`;
            }
            return `${days} days`;
        }
        
        // Check if date falls on workday
        function isWorkDay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return WORK_DAYS.includes(date.getDay());
        }
        
        // Count workdays in date range
        function countWorkdaysInRange(startDate, endDate) {
            let count = 0;
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const current = new Date(start);
            
            while (current <= end) {
                if (WORK_DAYS.includes(current.getDay())) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }
        
        // Calculate workdays and display
        function calculateWorkdays() {
            const startDate = document.getElementById('ptoStartDate').value;
            const endDate = document.getElementById('ptoEndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('workdayCalculation').classList.add('hidden');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                document.getElementById('workdayCalculation').innerHTML = 
                    '<div class="alert alert-danger">End date must be after start date</div>';
                document.getElementById('workdayCalculation').classList.remove('hidden');
                return;
            }
            
            const workdays = countWorkdaysInRange(startDate, endDate);
            calculatedWorkdays = workdays;
            
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let html = '<div class="date-calc-display">';
            html += `<strong>Date Range:</strong> ${totalDays} total ${totalDays === 1 ? 'day' : 'days'}<br>`;
            html += `<strong>Your Workdays (Sat/Sun/Mon):</strong> ${workdays} ${workdays === 1 ? 'day' : 'days'}<br>`;
            html += `<strong>PTO to be deducted:</strong> ${formatDays(workdays)}`;
            html += '</div>';
            
            document.getElementById('workdayCalculation').innerHTML = html;
            document.getElementById('workdayCalculation').classList.remove('hidden');
            
            // Check Tori holidays when dates change
            checkToriHolidays();
        }
        
        // Get holidays for a year
        function getHolidays(year) {
            const holidays = [];
            
            // Only Dan's paid holidays: Thanksgiving & Christmas
            WYOMING_HOLIDAYS.forEach(holiday => {
                if (holiday.name === 'Thanksgiving' || holiday.name === 'Christmas') {
                    const date = getObservedHolidayDate(year, holiday);
                    const dateStr = date.toISOString().split('T')[0];
                    holidays.push({ 
                        name: holiday.name, 
                        date: date,
                        isWorkDay: isWorkDay(dateStr)
                    });
                }
            });
            
            return holidays;
        }
        
        // Calculate total reserve used from planned PTO days
        function calculateReserveUsed() {
            let total = 0;
            state.plannedDays.forEach(day => {
                if (day.type === 'pto' && day.usesReserve) {
                    total += day.reserveDaysUsed || 0;
                }
            });
            return total;
        }
        
        // Step 1: Confirm Balance
        function confirmBalance() {
            const balance = parseFloat(document.getElementById('currentBalance').value);
            if (isNaN(balance) || balance < 0) {
                alert('Please enter a valid balance');
                return;
            }
            
            if (balance > 22) {
                alert('Planning balance cannot exceed 22 days');
                return;
            }
            
            state.currentBalance = balance;
            saveState();
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            updateMainBalance();
            displayPlannedDays();
        }
        
        // Update main balance display
        function updateMainBalance() {
            document.getElementById('mainBalance').textContent = formatDays(state.currentBalance);
            document.getElementById('planningDays').textContent = formatDays(state.currentBalance);
        }
        
        // Edit balance
        function editBalance() {
            const newBalance = prompt(`Update your planning balance:\n\n(Current: ${formatDays(state.currentBalance)})\n\nEnter new balance (max 22 days):`, state.currentBalance);
            
            if (newBalance === null) return;
            
            const parsed = parseFloat(newBalance);
            if (isNaN(parsed) || parsed < 0) {
                alert('Please enter a valid positive number');
                return;
            }
            
            if (parsed > 22) {
                alert('Planning balance cannot exceed 22 days');
                return;
            }
            
            state.currentBalance = parsed;
            saveState();
            updateMainBalance();
            alert(`‚úÖ Balance updated to ${formatDays(parsed)}`);
        }
        
        // Show plan PTO form
        function showPlanPTO() {
            document.getElementById('planPTOCard').classList.remove('hidden');
            document.getElementById('ptoWarnings').innerHTML = '';
            document.getElementById('workdayCalculation').classList.add('hidden');
            document.getElementById('toriHolidayWarnings').innerHTML = '';
            calculatedWorkdays = 0;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ptoStartDate').min = today;
            document.getElementById('ptoEndDate').min = today;
        }
        
        // Cancel plan PTO
        function cancelPlanPTO() {
            document.getElementById('planPTOCard').classList.add('hidden');
            document.getElementById('ptoStartDate').value = '';
            document.getElementById('ptoEndDate').value = '';
            document.getElementById('ptoPurpose').value = '';
            document.getElementById('ptoNotes').value = '';
            document.getElementById('toriComing').checked = false;
            document.getElementById('workdayCalculation').classList.add('hidden');
            document.getElementById('toriHolidayWarnings').innerHTML = '';
            calculatedWorkdays = 0;
        }
        
        // Save PTO
        function savePTO() {
            const startDate = document.getElementById('ptoStartDate').value;
            const endDate = document.getElementById('ptoEndDate').value;
            const purpose = document.getElementById('ptoPurpose').value;
            const notes = document.getElementById('ptoNotes').value;
            const toriComing = document.getElementById('toriComing').checked;
            
            if (!startDate || !endDate || !purpose) {
                alert('Please fill in start date, end date, and purpose');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const workdays = countWorkdaysInRange(startDate, endDate);
            
            if (workdays === 0) {
                alert('This date range contains no workdays (Sat/Sun/Mon). No PTO will be deducted.');
                return;
            }
            
            // Calculate if this uses reserve
            const usesReserve = workdays > state.currentBalance;
            const reserveUsed = usesReserve ? workdays - state.currentBalance : 0;
            
            if (usesReserve) {
                const confirm = window.confirm(
                    `‚ö†Ô∏è RESERVE WARNING\n\n` +
                    `This ${formatDays(workdays)} will use ${formatDays(reserveUsed)} from your 5-day emergency reserve.\n\n` +
                    `Current planning balance: ${formatDays(state.currentBalance)}\n` +
                    `Reserve days available: ${formatDays(state.reserveDays)}\n\n` +
                    `Do you want to proceed?`
                );
                
                if (!confirm) return;
            }
            
            const day = {
                type: 'pto',
                startDate,
                endDate,
                purpose,
                notes,
                daysUsed: workdays,
                balanceAfter: state.currentBalance - workdays,
                usesReserve,
                reserveDaysUsed: reserveUsed,
                toriComing
            };
            
            state.plannedDays.push(day);
            state.plannedDays.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            state.currentBalance -= workdays;
            
            saveState();
            cancelPlanPTO();
            updateMainBalance();
            displayPlannedDays();
            
            if (usesReserve) {
                alert(`‚úÖ PTO saved\n\n‚ö†Ô∏è Used ${formatDays(reserveUsed)} from reserve\n\nRemaining balance: ${formatDays(state.currentBalance)}`);
            } else {
                alert(`‚úÖ PTO saved\n\nWorkdays used: ${formatDays(workdays)}\nRemaining balance: ${formatDays(state.currentBalance)}`);
            }
        }
        
        // Show plan non-PTO form
        function showPlanNonPTO() {
            document.getElementById('planNonPTOCard').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('nonPtoDate').min = today;
        }
        
        // Cancel plan non-PTO
        function cancelPlanNonPTO() {
            document.getElementById('planNonPTOCard').classList.add('hidden');
            document.getElementById('nonPtoDate').value = '';
            document.getElementById('nonPtoPurpose').value = '';
            document.getElementById('nonPtoNotes').value = '';
        }
        
        // Save non-PTO
        function saveNonPTO() {
            const date = document.getElementById('nonPtoDate').value;
            const purpose = document.getElementById('nonPtoPurpose').value;
            const notes = document.getElementById('nonPtoNotes').value;
            
            if (!date || !purpose) {
                alert('Please fill in date and activity');
                return;
            }
            
            const day = {
                type: 'non-pto',
                startDate: date,
                endDate: date,
                purpose,
                notes,
                daysUsed: 0,
                balanceAfter: state.currentBalance
            };
            
            state.plannedDays.push(day);
            state.plannedDays.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            saveState();
            cancelPlanNonPTO();
            displayPlannedDays();
            
            alert(`‚úÖ Day planned (no PTO impact)`);
        }
        
        // Display planned days
        function displayPlannedDays() {
            const container = document.getElementById('mainDaysList');
            
            if (state.plannedDays.length === 0) {
                container.innerHTML = '<div class="no-trips">No days planned yet. Start planning!</div>';
                return;
            }
            
            let html = '';
            state.plannedDays.forEach((day, idx) => {
                const startDate = new Date(day.startDate + 'T00:00:00');
                const endDate = new Date(day.endDate + 'T00:00:00');
                const isSingleDay = day.startDate === day.endDate;
                
                let dateStr;
                if (isSingleDay) {
                    dateStr = startDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
                } else {
                    const startStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    dateStr = `${startStr} - ${endStr}`;
                }
                
                const isPTO = day.type === 'pto';
                const icon = isPTO ? 'üèñÔ∏è' : 'üóìÔ∏è';
                const cardClass = isPTO ? '' : 'non-pto';
                
                html += `
                    <div class="trip-card ${cardClass}">
                        <h4>${icon} ${day.purpose}${day.usesReserve ? '<span class="reserve-badge">RESERVE</span>' : ''}</h4>
                        <div class="trip-dates">üìÖ ${dateStr}</div>
                        ${isPTO ? `
                            <div class="trip-detail">PTO Used: ${formatDays(day.daysUsed)}</div>
                            ${day.usesReserve ? `<div class="trip-detail" style="color: #856404;">‚ö†Ô∏è Reserve Used: ${formatDays(day.reserveDaysUsed)}</div>` : ''}
                            ${day.toriComing ? `<div class="trip-detail" style="color: #17a2b8;">üë• Tori is coming</div>` : ''}
                            <div class="trip-balance">
                                <strong>Balance After:</strong> ${formatDays(day.balanceAfter)}
                            </div>
                        ` : `
                            <div class="trip-detail">Regular day off - No PTO impact</div>
                        `}
                        ${day.notes ? `
                            <div class="trip-notes">
                                üìù <strong>Notes:</strong> ${day.notes}
                            </div>
                        ` : ''}
                `;
                
                // Show Tori holiday suggestions for saved trips
                if (isPTO && day.toriComing) {
                    const nearbyHolidays = getToriHolidaysNear(day.startDate, day.endDate);
                    if (nearbyHolidays.length > 0) {
                        nearbyHolidays.forEach(h => {
                            const dateStr = h.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                            
                            if (h.daysBefore > 0) {
                                html += `
                                    <div class="tori-holiday-highlight">
                                        üìÖ <strong>${h.name}</strong> is ${h.daysBefore} day${h.daysBefore !== 1 ? 's' : ''} before trip (${dateStr})
                                    </div>
                                    <div class="trip-suggestion">
                                        üí° Could have started on ${dateStr} to save Tori ${h.daysBefore} day${h.daysBefore !== 1 ? 's' : ''} of PTO
                                    </div>
                                `;
                            } else if (h.daysAfter > 0) {
                                html += `
                                    <div class="tori-holiday-highlight">
                                        üìÖ <strong>${h.name}</strong> is ${h.daysAfter} day${h.daysAfter !== 1 ? 's' : ''} after trip (${dateStr})
                                    </div>
                                    <div class="trip-suggestion">
                                        üí° Could extend to ${dateStr} to save Tori ${h.daysAfter} day${h.daysAfter !== 1 ? 's' : ''} of PTO
                                    </div>
                                `;
                            }
                        });
                    }
                }
                
                html += `
                        <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 12px;">
                            <button class="delete-btn" onclick="deleteDay(${idx})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Delete day
        function deleteDay(idx) {
            if (!confirm('Delete this planned day?')) return;
            
            const day = state.plannedDays[idx];
            if (day.type === 'pto') {
                state.currentBalance += day.daysUsed;
            }
            
            state.plannedDays.splice(idx, 1);
            saveState();
            updateMainBalance();
            displayPlannedDays();
        }
        
        // Show holidays
        function showHolidays() {
            const currentYear = new Date().getFullYear();
            
            let html = '<div class="alert alert-info" style="margin-bottom: 20px;">';
            html += '<strong>Dan\'s Workdays:</strong> Saturday, Sunday, Monday<br>';
            html += '<strong>Dan\'s Paid Holidays:</strong> Thanksgiving & Christmas<br>';
            html += '‚ö†Ô∏è If a holiday falls on your workday, you must use PTO<br><br>';
            html += '<strong>All Wyoming State Holidays (Tori has these off):</strong>';
            html += '</div>';
            
            // Show all Wyoming holidays for context
            html += '<h4 style="color: #2c5f2d; margin: 20px 0 10px;">All Wyoming State Holidays</h4>';
            html += '<div class="holiday-list">';
            
            [currentYear, currentYear + 1, currentYear + 2].forEach(year => {
                WYOMING_HOLIDAYS.forEach(holiday => {
                    const date = getObservedHolidayDate(year, holiday);
                    const dateStr = date.toISOString().split('T')[0];
                    const isDanHoliday = holiday.name === 'Thanksgiving' || holiday.name === 'Christmas';
                    const isWorkDay = isWorkDay(dateStr);
                    const workdayClass = isDanHoliday && isWorkDay ? 'workday' : '';
                    
                    html += `
                        <div class="holiday-item ${workdayClass}">
                            <strong>${holiday.name} ${year}</strong><br>
                            ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}<br>
                            ${isDanHoliday ? (isWorkDay ? '<span style="color: #856404;">‚ö†Ô∏è Dan\'s workday - requires PTO</span>' : '<span style="color: #28a745;">‚úì Dan\'s paid holiday</span>') : '<span style="color: #17a2b8;">Tori has off</span>'}
                        </div>
                    `;
                });
            });
            html += '</div>';
            
            document.getElementById('holidaysList').innerHTML = html;
            document.getElementById('holidaysCard').classList.remove('hidden');
        }
        
        function hideHolidays() {
            document.getElementById('holidaysCard').classList.add('hidden');
        }
        
        // Show projections
        function showProjections() {
            const feb1Next = new Date(new Date().getFullYear() + 1, 1, 1);
            const reserveUsedThisYear = calculateReserveUsed();
            const nextYearPlanning = 22 - reserveUsedThisYear;
            
            let html = '<div class="projection">';
            html += '<h4>Current Status</h4>';
            html += `<p><strong>Planning Balance:</strong> ${formatDays(state.currentBalance)}</p>`;
            html += `<p><strong>Reserve Days:</strong> ${formatDays(state.reserveDays)}</p>`;
            html += `<p><strong>Reserve Used This Year:</strong> ${formatDays(reserveUsedThisYear)}</p>`;
            html += '</div>';
            
            html += '<div class="projection">';
            html += `<h4>Next PTO Year (Feb 1, ${feb1Next.getFullYear()})</h4>`;
            html += `<p><strong>New Annual Grant:</strong> 22 days</p>`;
            if (reserveUsedThisYear > 0) {
                html += `<p style="color: #856404;"><strong>Minus Payback:</strong> -${formatDays(reserveUsedThisYear)} (to restore reserve)</p>`;
            }
            html += `<p><strong>Planning Allowance:</strong> ${formatDays(nextYearPlanning)}</p>`;
            html += `<p><strong>Reserve:</strong> 5 days (restored)</p>`;
            html += `<p><strong>Total Available:</strong> ${formatDays(nextYearPlanning + 5)}</p>`;
            html += '</div>';
            
            if (reserveUsedThisYear > 0) {
                html += '<div class="alert alert-warning">';
                html += `<strong>‚ö†Ô∏è Reserve Payback Notice:</strong><br>`;
                html += `You've used ${formatDays(reserveUsedThisYear)} from reserve this year. `;
                html += `On Feb 1, ${feb1Next.getFullYear()}, your planning allowance will be ${formatDays(nextYearPlanning)} `;
                html += `(22 days minus ${formatDays(reserveUsedThisYear)} payback to restore the 5-day reserve).`;
                html += '</div>';
            }
            
            document.getElementById('projectionsList').innerHTML = html;
            document.getElementById('projectionsCard').classList.remove('hidden');
        }
        
        function hideProjections() {
            document.getElementById('projectionsCard').classList.add('hidden');
        }
        
        // Initialize
        async function init() {
            await loadState();
            document.getElementById('currentBalance').value = state.currentBalance;
        }
        
        init();
    </script>
</body>
</html>
