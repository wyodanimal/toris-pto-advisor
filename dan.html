<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dan's PTO Advisor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2c5f2d;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .balance-display {
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .balance-display h2 {
            font-size: 48px;
            margin-bottom: 5px;
        }
        
        .balance-display p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .balance-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .balance-item {
            font-size: 13px;
        }
        
        .balance-item strong {
            display: block;
            font-size: 18px;
            margin-top: 5px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c5f2d;
        }
        
        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #2c5f2d 0%, #97bc62 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            color: #0c5460;
        }
        
        .alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        
        .alert-danger {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        
        /* FIX 5: Super condensed single-line trip cards */
        .trip-card {
            background: #e8f5e9; /* Light green for PTO */
            padding: 10px 12px; /* Even more reduced */
            border-radius: 6px;
            margin-bottom: 8px; /* Tighter spacing */
            border-left: 4px solid #2c5f2d;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .trip-card.non-pto {
            background: #f5f5f5; /* Light gray for non-PTO */
            border-left-color: #6c757d;
        }
        
        /* FIX 5: Single line main info */
        .trip-main-line {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 300px;
        }
        
        /* FIX 4: Orange text for hunting */
        .trip-main-line.hunting {
            color: #ff6600;
            font-weight: 600;
        }
        
        .trip-emoji {
            font-size: 18px;
        }
        
        .trip-divider {
            color: #999;
            margin: 0 4px;
        }
        
        /* Buttons on same line */
        .trip-actions {
            display: flex;
            gap: 6px;
        }
        
        /* Notes on separate line if present */
        .trip-notes-compact {
            width: 100%;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 12px;
            color: #666;
        }
        
        .reserve-badge {
            display: inline-block;
            background: #ffc107;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .no-trips {
            text-align: center;
            padding: 40px;
            color: #adb5bd;
            font-style: italic;
        }
        
        .holiday-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .holiday-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .holiday-item strong {
            color: #2c5f2d;
        }
        
        .holiday-item.workday {
            border: 2px solid #ffc107;
            background: #fff3cd;
        }
        
        .hidden {
            display: none;
        }
        
        .projection {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .projection h4 {
            color: #2c5f2d;
            margin-bottom: 10px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .edit-btn:hover {
            background: #138496;
        }
        
        .date-calc-display {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            border: 2px solid #17a2b8;
        }
        
        .date-calc-display strong {
            color: #2c5f2d;
        }
        
        /* Form cards */
        .inline-form-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 2px solid #2c5f2d;
        }
        
        /* FIX 2: Edit form injected inline */
        .edit-form-inline {
            background: #fff9e6;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üèîÔ∏è Dan's PTO Advisor</h1>
            <p class="subtitle">Salary Employee - Day-Based Tracking</p>
            
            <!-- Step 1: Confirm Balance -->
            <div id="step1">
                <h3 style="color: #2c5f2d; margin-bottom: 20px;">Step 1: Confirm Current PTO Balance</h3>
                <div class="form-group">
                    <label>Current Planning Balance (days)</label>
                    <input type="number" id="currentBalance" step="0.5" value="22" placeholder="Enter planning balance">
                    <p style="font-size: 12px; color: #6c757d; margin-top: 5px;">Enter as days (e.g., 22 or 18.5 or -2). You have 5 reserve days separate.</p>
                </div>
                <button onclick="confirmBalance()">Confirm Balance</button>
            </div>
            
            <!-- Step 2: Main Interface -->
            <div id="step2" class="hidden">
                <div class="balance-display" onclick="editBalance()" style="cursor: pointer;" title="Click to edit balance">
                    <h2 id="mainBalance">22 days</h2>
                    <p>Planning Balance (click to edit)</p>
                    <div class="balance-breakdown">
                        <div class="balance-item">
                            Planning Allowance
                            <strong id="planningDays">22 days</strong>
                        </div>
                        <div class="balance-item">
                            Reserve (Emergency)
                            <strong id="reserveDays">5 days</strong>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="showPlanPTO()">üìÖ Plan PTO Days</button>
                    <button onclick="showPlanNonPTO()" class="btn-secondary">üóìÔ∏è Plan Non-PTO Day</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button onclick="showHolidays()" class="btn-warning">üéÑ View Holidays</button>
                    <button onclick="showProjections()" class="btn-success">üìä View Projections</button>
                </div>
                
                <!-- Plan PTO Modal - above planned days -->
                <div id="planPTOCard" class="inline-form-card hidden">
                    <h3 style="color: #2c5f2d; margin-bottom: 15px;" id="ptoFormTitle">Plan PTO Days</h3>
                    
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="ptoStartDate" onchange="syncEndDateMonth(); calculateWorkdays();">
                    </div>
                    
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="ptoEndDate" onchange="calculateWorkdays()">
                    </div>
                    
                    <div id="workdayCalculation" class="hidden"></div>
                    
                    <div class="form-group">
                        <label>Purpose</label>
                        <input type="text" id="ptoPurpose" placeholder="e.g., Family trip, Doctor appointment">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="ptoNotes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <div id="ptoWarnings"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button onclick="savePTO()">Save PTO</button>
                        <button onclick="cancelPlanPTO()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
                
                <!-- Plan Non-PTO Modal - above planned days -->
                <div id="planNonPTOCard" class="inline-form-card hidden">
                    <h3 style="color: #6c757d; margin-bottom: 15px;" id="nonPtoFormTitle">Plan Non-PTO Days</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">Track what you're doing on your regular days off (Thu/Fri) - doesn't impact PTO balance</p>
                    
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="nonPtoStartDate">
                    </div>
                    
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="nonPtoEndDate">
                    </div>
                    
                    <div class="form-group">
                        <label>Activity/Plans</label>
                        <input type="text" id="nonPtoPurpose" placeholder="e.g., Hunting trip, Bike ride, Errands">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="nonPtoNotes" rows="2" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button onclick="saveNonPTO()" class="btn-secondary">Save Days</button>
                        <button onclick="cancelPlanNonPTO()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
                
                <!-- Planned Days Section -->
                <div id="plannedDaysMain">
                    <h3 style="color: #2c5f2d; margin: 20px 0 12px 0; border-bottom: 2px solid #2c5f2d; padding-bottom: 8px;">üóìÔ∏è Your Planned Days</h3>
                    <div id="mainDaysList"></div>
                </div>
            </div>
        </div>
        
        <!-- Holidays Modal -->
        <div id="holidaysCard" class="card hidden">
            <h3 style="color: #2c5f2d; margin-bottom: 20px;">üéÑ Paid Holidays & Workday Check</h3>
            <div id="holidaysList"></div>
            <button onclick="hideHolidays()" class="btn-secondary" style="margin-top: 20px;">Close</button>
        </div>
        
        <!-- Projections Modal -->
        <div id="projectionsCard" class="card hidden">
            <h3 style="color: #2c5f2d; margin-bottom: 20px;">üìä PTO Balance Projections</h3>
            <div id="projectionsList"></div>
            <button onclick="hideProjections()" class="btn-secondary" style="margin-top: 20px;">Close</button>
        </div>
    </div>
    
    <script>
        // Google Sheets Configuration
        const SPREADSHEET_ID = '107ByQVrvKaBV-IgB9WzSKJnTx5k-9m-VXNg6j25WEec';
        const SHEET_BALANCE = 'Dan_Balance';
        const SHEET_TRIPS = 'Dan_Trips';
        
        // Service Account Credentials
        const SERVICE_ACCOUNT = {
            client_email: "tori-pto-service@tori-pto-advisor.iam.gserviceaccount.com",
            private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCzCb9Z3IONbhi2\nMlP5OLTFyGmqpt0UZhggB3rZdn+myXle4qzJbDvqe4NcZMq0n+EMbY+UOQHzj4WE\nf1w0cYg0b6gLBTLbZXrJ446ab1pgCVbq9DuHEfIpfG3G07SkISj8rrbb0uFwiaA0\n5tcbBZ2nLdZYipAM0ujRyOsrFaiv4JUMk6vE9SuyyI3PVK6LCoPqb9iQyBlNYhPk\nB+1SL/KGjRVjkPEk68+x1w48BKcRMy0YN015V/eo45Oh2KRd3dV1ubJ4D7IcSzsg\nFGeVV+C//MrRLeOYEy1BaCaGKTT+VHtJeUt06robTyJaWJnZt7YSARRuJb3kxoRH\nJMy2bk0PAgMBAAECggEAAvwMHQ7ggIiPz+W54aMw3EUxgb9DWzYye8I0KZDgouKj\n69GCiN8NhqSldXJWsLkjksX2yUVEA4/mbWWEH3mvCBS+a+Sbyu1/pQLumyN1EbnG\nIaeNoHxLmaZx3Akmb0AAQ2oUMUjsKiiZK5iXiGNJFALfGl3A9f3EFM8xIGg9hiUE\nm1ePBPPXY2VItEG9Z8ry+AFHDreT7x/fekMXTfnpqFRLddE2ioucSshRzW7U+UAN\nOvt1V166PrUuIHtAveKaStTULzEPZS6By6viRpUIIDftvfgAptEFMLnpOC/QrZVo\n7tif6V36o03om42zQtrc6ygYwgD0Tj/sPa6kJHxQtQKBgQDrrmLZKbLKeK1A6ngC\niEWqKAd9NrUfbcbUIXEJVlAYbqEWQhJs10UJgWkqvnbgOmimX24YvKQrr4EV2Yan\nDTCtqeanRbMXpuSWCFjftp1RtmhKdrUQ4zIIgjD0ESbviRKWHJwdJiGxUZrkPvMV\n3nPeXRAWnAWmLeeNHYa15muEswKBgQDCeTdqkEdWgnkByIWVChEt5I+1c3d3TprB\nqWIm3i5vxTdho2METSWy/+XX1Qrtmb5YjUZCfD8xc7hLA2X41KNFsCVJwbYYWgIB\n9fKcB6nfeCsuexpcpjGh75R4nU39bUUOAUQbNlLu8h09pbF68nLguUXWUEJ3RWd2\nQl3O2FbcNQKBgBWjWB36Dxk5xSZdoJES89pwfGeJm018ZbHaNCeYThhAJ/gELu7h\nQMxjnkU3YXCqzCriPhh1UVlVbrOT2iICOwLmw29+HbhBMWF4+Lfpaz4yUhbsGSmo\nwlI3qcjuvjVlz1gK3mZqttMx29ey09yhJOA4iR6aSoZ8VnMFT/XpZtuzAoGBAI7O\n8PDiLmDKww2aMO43TFJFK3r15d7I7EAWoKsmMTeGvZqHnujDtlFyNVh/a9z7L5pb\ndCLSlp07+zOqtTE7BQLhzSASjiPnxN2nvJbz0bz2w88IO12Z9YyTIJZJ/cGCglk8\neMT66X/qb6qbiG9epxl7NFui6IwpfUaMidKhb3eZAoGAEmcmFmtljyUU1NOvbtgM\nIrFA0QlDalsJD/HSZsslCrrwsHpgX6oxhyg425wgmFcC8MiBRkqyMJMPouxqKToo\njIfXjTWVU3pF89QW+MRN0gCHsLppH/rXMFgU7liCuCIw94NqJ3xKS7bnsuGbYKey\nSVB5YETSRSvhZb6+LKJFgH4=\n-----END PRIVATE KEY-----\n"
        };
        
        // State
        let state = {
            currentBalance: 22,
            reserveDays: 5,
            reserveUsedThisYear: 0,
            plannedDays: [],
            lastUpdated: new Date().toISOString()
        };
        
        let accessToken = null;
        let calculatedWorkdays = 0;
        let editingIndex = -1;
        
        // Work schedule - Dan works Sat/Sun/Mon
        const WORK_DAYS = [0, 1, 6];
        
        // FIX 4: Emoji mapping based on keywords
        function getEmojiForPurpose(purpose) {
            const lower = purpose.toLowerCase();
            
            // Check for specific keywords
            if (lower.includes('elk')) return 'ü¶å';
            if (lower.includes('deer')) return 'ü¶å';
            if (lower.includes('bear')) return 'üêª';
            if (lower.includes('turkey')) return 'ü¶É';
            if (lower.includes('ice fishing')) return 'üé£‚ùÑÔ∏è';
            if (lower.includes('fishing')) return 'üé£';
            if (lower.includes('camping') || lower.includes('camp')) return '‚õ∫';
            if (lower.includes('bikepacking')) return 'üöµ‚Äç‚ôÇÔ∏è';
            if (lower.includes('biking') || lower.includes('bike') || lower.includes('cycling')) return 'üö¥‚Äç‚ôÇÔ∏è';
            if (lower.includes('cruise')) return 'üö¢';
            
            // Default vacation emoji
            return 'üèñÔ∏è';
        }
        
        // FIX 4: Check if purpose is hunting-related
        function isHunting(purpose) {
            const lower = purpose.toLowerCase();
            return lower.includes('hunt') || lower.includes('elk') || 
                   lower.includes('deer') || lower.includes('bear') || lower.includes('turkey');
        }
        
        // Sync end date calendar to start date month
        function syncEndDateMonth() {
            const startDate = document.getElementById('ptoStartDate').value;
            if (startDate) {
                document.getElementById('ptoEndDate').value = startDate;
            }
        }
        
        // Get OAuth access token
        async function getAccessToken() {
            if (accessToken) return accessToken;
            
            const header = { alg: 'RS256', typ: 'JWT' };
            const now = Math.floor(Date.now() / 1000);
            const claim = {
                iss: SERVICE_ACCOUNT.client_email,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                aud: 'https://oauth2.googleapis.com/token',
                exp: now + 3600,
                iat: now
            };
            
            const base64Header = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            const base64Claim = btoa(JSON.stringify(claim)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            const pemHeader = "-----BEGIN PRIVATE KEY-----";
            const pemFooter = "-----END PRIVATE KEY-----";
            const pemContents = SERVICE_ACCOUNT.private_key.substring(
                pemHeader.length,
                SERVICE_ACCOUNT.private_key.length - pemFooter.length - 1
            ).replace(/\s/g, '');
            
            const binaryKey = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));
            const cryptoKey = await crypto.subtle.importKey(
                'pkcs8', binaryKey,
                { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
                false, ['sign']
            );
            
            const signatureData = new TextEncoder().encode(`${base64Header}.${base64Claim}`);
            const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', cryptoKey, signatureData);
            const base64Signature = btoa(String.fromCharCode(...new Uint8Array(signature)))
                .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
            
            const jwt = `${base64Header}.${base64Claim}.${base64Signature}`;
            
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
            });
            
            const data = await response.json();
            accessToken = data.access_token;
            setTimeout(() => { accessToken = null; }, 3500 * 1000);
            
            return accessToken;
        }
        
        // Load state from Google Sheets
        async function loadState() {
            try {
                const token = await getAccessToken();
                
                const balanceResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_BALANCE}!B1`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const balanceData = await balanceResponse.json();
                
                if (balanceData.values && balanceData.values[0] && balanceData.values[0][0]) {
                    state.currentBalance = parseFloat(balanceData.values[0][0]);
                }
                
                const tripsResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2:J1000`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );
                const tripsData = await tripsResponse.json();
                
                state.plannedDays = [];
                if (tripsData.values && tripsData.values.length > 0) {
                    state.plannedDays = tripsData.values
                        .filter(row => row[0])
                        .map(row => ({
                            type: row[0],
                            startDate: row[1],
                            endDate: row[2] || row[1],
                            purpose: row[3],
                            notes: row[4] || '',
                            daysUsed: parseFloat(row[5]) || 0,
                            balanceAfter: parseFloat(row[6]) || 0,
                            usesReserve: row[7] === 'true',
                            reserveDaysUsed: parseFloat(row[8]) || 0,
                            toriComing: row[9] === 'true'
                        }));
                }
                
                console.log('‚úì Loaded from Google Sheets');
            } catch (error) {
                console.error('Error loading:', error);
            }
        }
        
        // Save state to Google Sheets
        async function saveState() {
            try {
                const token = await getAccessToken();
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_BALANCE}!B1?valueInputOption=RAW`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values: [[state.currentBalance]] })
                    }
                );
                
                await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2:J1000:clear`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    }
                );
                
                if (state.plannedDays.length > 0) {
                    const rows = state.plannedDays.map(day => [
                        day.type,
                        day.startDate,
                        day.endDate || day.startDate,
                        day.purpose,
                        day.notes || '',
                        day.daysUsed,
                        day.balanceAfter,
                        day.usesReserve ? 'true' : 'false',
                        day.reserveDaysUsed || 0,
                        day.toriComing ? 'true' : 'false'
                    ]);
                    
                    await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_TRIPS}!A2?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ values: rows })
                        }
                    );
                }
                
                console.log('‚úì Saved to Google Sheets');
            } catch (error) {
                console.error('Error saving:', error);
            }
        }
        
        // Format days
        function formatDays(days) {
            if (days === Math.floor(days)) {
                return `${days} ${Math.abs(days) === 1 ? 'day' : 'days'}`;
            }
            return `${days} days`;
        }
        
        // Check if date falls on workday
        function isWorkDay(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return WORK_DAYS.includes(date.getDay());
        }
        
        // Count workdays in date range
        function countWorkdaysInRange(startDate, endDate) {
            let count = 0;
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const current = new Date(start);
            
            while (current <= end) {
                if (WORK_DAYS.includes(current.getDay())) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }
        
        // Calculate workdays and display
        function calculateWorkdays() {
            const startDate = document.getElementById('ptoStartDate').value;
            const endDate = document.getElementById('ptoEndDate').value;
            
            if (!startDate || !endDate) {
                document.getElementById('workdayCalculation').classList.add('hidden');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                document.getElementById('workdayCalculation').innerHTML = 
                    '<div class="alert alert-danger">End date must be after start date</div>';
                document.getElementById('workdayCalculation').classList.remove('hidden');
                return;
            }
            
            const workdays = countWorkdaysInRange(startDate, endDate);
            calculatedWorkdays = workdays;
            
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let html = '<div class="date-calc-display">';
            html += `<strong>Date Range:</strong> ${totalDays} total ${totalDays === 1 ? 'day' : 'days'}<br>`;
            html += `<strong>Your Workdays (Sat/Sun/Mon):</strong> ${workdays} ${workdays === 1 ? 'day' : 'days'}<br>`;
            html += `<strong>PTO to be deducted:</strong> ${formatDays(workdays)}`;
            html += '</div>';
            
            document.getElementById('workdayCalculation').innerHTML = html;
            document.getElementById('workdayCalculation').classList.remove('hidden');
        }
        
        // Calculate total reserve used from planned PTO days
        function calculateReserveUsed() {
            let total = 0;
            state.plannedDays.forEach(day => {
                if (day.type === 'pto' && day.usesReserve) {
                    total += day.reserveDaysUsed || 0;
                }
            });
            return total;
        }
        
        // Calculate reserve remaining properly when PTO goes negative
        function calculateReserveRemaining() {
            if (state.currentBalance >= 0) {
                return state.reserveDays;
            } else {
                return Math.max(0, state.reserveDays + state.currentBalance);
            }
        }
        
        // Step 1: Confirm Balance
        function confirmBalance() {
            const balance = parseFloat(document.getElementById('currentBalance').value);
            if (isNaN(balance)) {
                alert('Please enter a valid balance');
                return;
            }
            
            state.currentBalance = balance;
            saveState();
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            updateMainBalance();
            displayPlannedDays();
        }
        
        // Update main balance display
        function updateMainBalance() {
            const reserveRemaining = calculateReserveRemaining();
            
            document.getElementById('mainBalance').textContent = formatDays(state.currentBalance);
            document.getElementById('planningDays').textContent = formatDays(state.currentBalance);
            document.getElementById('reserveDays').textContent = formatDays(reserveRemaining);
        }
        
        // Edit balance
        function editBalance() {
            const newBalance = prompt(`Update your planning balance:\n\n(Current: ${formatDays(state.currentBalance)})\n\nEnter new balance (can be negative):`, state.currentBalance);
            
            if (newBalance === null) return;
            
            const parsed = parseFloat(newBalance);
            if (isNaN(parsed)) {
                alert('Please enter a valid number');
                return;
            }
            
            state.currentBalance = parsed;
            saveState();
            updateMainBalance();
            alert(`‚úÖ Balance updated to ${formatDays(parsed)}`);
        }
        
        // Show plan PTO form
        function showPlanPTO() {
            editingIndex = -1;
            document.getElementById('ptoFormTitle').textContent = 'Plan PTO Days';
            document.getElementById('planNonPTOCard').classList.add('hidden');
            document.getElementById('planPTOCard').classList.remove('hidden');
            document.getElementById('ptoWarnings').innerHTML = '';
            document.getElementById('workdayCalculation').classList.add('hidden');
            calculatedWorkdays = 0;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ptoStartDate').min = today;
            document.getElementById('ptoEndDate').min = today;
            
            document.getElementById('planPTOCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Cancel plan PTO
        function cancelPlanPTO() {
            editingIndex = -1;
            document.getElementById('planPTOCard').classList.add('hidden');
            document.getElementById('ptoStartDate').value = '';
            document.getElementById('ptoEndDate').value = '';
            document.getElementById('ptoPurpose').value = '';
            document.getElementById('ptoNotes').value = '';
            document.getElementById('workdayCalculation').classList.add('hidden');
            calculatedWorkdays = 0;
        }
        
        // FIX 2: Edit day - inject form right above the trip
        function editDay(idx) {
            const day = state.plannedDays[idx];
            
            if (day.type === 'pto') {
                // Restore balance before editing
                state.currentBalance += day.daysUsed;
                
                editingIndex = idx;
                
                // Build inline edit form HTML
                let formHtml = `
                    <div class="edit-form-inline" id="inlineEditForm">
                        <h3 style="color: #17a2b8; margin-bottom: 15px;">‚úèÔ∏è Edit PTO Days</h3>
                        
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="ptoStartDateEdit" value="${day.startDate}" onchange="syncEndDateMonthEdit(); calculateWorkdaysEdit();">
                        </div>
                        
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="ptoEndDateEdit" value="${day.endDate}" onchange="calculateWorkdaysEdit()">
                        </div>
                        
                        <div id="workdayCalculationEdit" class="hidden"></div>
                        
                        <div class="form-group">
                            <label>Purpose</label>
                            <input type="text" id="ptoPurposeEdit" value="${day.purpose}" placeholder="e.g., Family trip, Doctor appointment">
                        </div>
                        
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="ptoNotesEdit" rows="2" placeholder="Additional details...">${day.notes}</textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="saveEditedPTO()" style="background: #17a2b8;">Save Changes</button>
                            <button onclick="cancelEdit()" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                `;
                
                // Inject form right above this trip card
                displayPlannedDays(idx, formHtml);
                
                // Scroll to form
                document.getElementById('inlineEditForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                // Edit non-PTO - same approach
                editingIndex = idx;
                
                let formHtml = `
                    <div class="edit-form-inline" id="inlineEditForm">
                        <h3 style="color: #6c757d; margin-bottom: 15px;">‚úèÔ∏è Edit Non-PTO Days</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 13px;">Track what you're doing on your regular days off</p>
                        
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="nonPtoStartDateEdit" value="${day.startDate}">
                        </div>
                        
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="nonPtoEndDateEdit" value="${day.endDate}">
                        </div>
                        
                        <div class="form-group">
                            <label>Activity/Plans</label>
                            <input type="text" id="nonPtoPurposeEdit" value="${day.purpose}" placeholder="e.g., Hunting trip, Bike ride">
                        </div>
                        
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <textarea id="nonPtoNotesEdit" rows="2" placeholder="Additional details...">${day.notes}</textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="saveEditedNonPTO()" class="btn-secondary">Save Changes</button>
                            <button onclick="cancelEdit()" class="btn-secondary">Cancel</button>
                        </div>
                    </div>
                `;
                
                displayPlannedDays(idx, formHtml);
                document.getElementById('inlineEditForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Helper functions for inline edit
        function syncEndDateMonthEdit() {
            const startDate = document.getElementById('ptoStartDateEdit').value;
            if (startDate) {
                document.getElementById('ptoEndDateEdit').value = startDate;
            }
        }
        
        function calculateWorkdaysEdit() {
            const startDate = document.getElementById('ptoStartDateEdit').value;
            const endDate = document.getElementById('ptoEndDateEdit').value;
            
            if (!startDate || !endDate) {
                document.getElementById('workdayCalculationEdit').classList.add('hidden');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                document.getElementById('workdayCalculationEdit').innerHTML = 
                    '<div class="alert alert-danger">End date must be after start date</div>';
                document.getElementById('workdayCalculationEdit').classList.remove('hidden');
                return;
            }
            
            const workdays = countWorkdaysInRange(startDate, endDate);
            calculatedWorkdays = workdays;
            
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let html = '<div class="date-calc-display">';
            html += `<strong>Date Range:</strong> ${totalDays} total ${totalDays === 1 ? 'day' : 'days'}<br>`;
            html += `<strong>Your Workdays (Sat/Sun/Mon):</strong> ${workdays} ${workdays === 1 ? 'day' : 'days'}<br>`;
            html += `<strong>PTO to be deducted:</strong> ${formatDays(workdays)}`;
            html += '</div>';
            
            document.getElementById('workdayCalculationEdit').innerHTML = html;
            document.getElementById('workdayCalculationEdit').classList.remove('hidden');
        }
        
        function cancelEdit() {
            if (editingIndex >= 0 && state.plannedDays[editingIndex].type === 'pto') {
                // Restore the balance we added when we started editing
                const day = state.plannedDays[editingIndex];
                state.currentBalance -= day.daysUsed;
            }
            editingIndex = -1;
            displayPlannedDays();
        }
        
        function saveEditedPTO() {
            const startDate = document.getElementById('ptoStartDateEdit').value;
            const endDate = document.getElementById('ptoEndDateEdit').value;
            const purpose = document.getElementById('ptoPurposeEdit').value;
            const notes = document.getElementById('ptoNotesEdit').value;
            
            if (!startDate || !endDate || !purpose) {
                alert('Please fill in start date, end date, and purpose');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const workdays = countWorkdaysInRange(startDate, endDate);
            
            if (workdays === 0) {
                alert('This date range contains no workdays (Sat/Sun/Mon). No PTO will be deducted.');
                return;
            }
            
            const usesReserve = workdays > state.currentBalance;
            const reserveUsed = usesReserve ? workdays - state.currentBalance : 0;
            
            if (usesReserve) {
                const reserveRemaining = calculateReserveRemaining();
                const confirm = window.confirm(
                    `‚ö†Ô∏è RESERVE WARNING\n\n` +
                    `This ${formatDays(workdays)} will use ${formatDays(reserveUsed)} from your 5-day emergency reserve.\n\n` +
                    `Current planning balance: ${formatDays(state.currentBalance)}\n` +
                    `Reserve days available: ${formatDays(reserveRemaining)}\n\n` +
                    `Do you want to proceed?`
                );
                
                if (!confirm) {
                    const oldDay = state.plannedDays[editingIndex];
                    state.currentBalance -= oldDay.daysUsed;
                    return;
                }
            }
            
            const day = {
                type: 'pto',
                startDate,
                endDate,
                purpose,
                notes,
                daysUsed: workdays,
                balanceAfter: state.currentBalance - workdays,
                usesReserve,
                reserveDaysUsed: reserveUsed,
                toriComing: false
            };
            
            state.plannedDays[editingIndex] = day;
            state.plannedDays.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            state.currentBalance -= workdays;
            
            saveState();
            editingIndex = -1;
            updateMainBalance();
            displayPlannedDays();
            
            alert(`‚úÖ PTO updated\n\nWorkdays used: ${formatDays(workdays)}\nRemaining balance: ${formatDays(state.currentBalance)}`);
        }
        
        function saveEditedNonPTO() {
            const startDate = document.getElementById('nonPtoStartDateEdit').value;
            const endDate = document.getElementById('nonPtoEndDateEdit').value;
            const purpose = document.getElementById('nonPtoPurposeEdit').value;
            const notes = document.getElementById('nonPtoNotesEdit').value;
            
            if (!startDate || !endDate || !purpose) {
                alert('Please fill in start date, end date, and activity');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const day = {
                type: 'non-pto',
                startDate,
                endDate,
                purpose,
                notes,
                daysUsed: 0,
                balanceAfter: state.currentBalance
            };
            
            state.plannedDays[editingIndex] = day;
            state.plannedDays.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            saveState();
            editingIndex = -1;
            displayPlannedDays();
            
            alert(`‚úÖ Days updated (no PTO impact)`);
        }
        
        // Save PTO
        function savePTO() {
            const startDate = document.getElementById('ptoStartDate').value;
            const endDate = document.getElementById('ptoEndDate').value;
            const purpose = document.getElementById('ptoPurpose').value;
            const notes = document.getElementById('ptoNotes').value;
            
            if (!startDate || !endDate || !purpose) {
                alert('Please fill in start date, end date, and purpose');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const workdays = countWorkdaysInRange(startDate, endDate);
            
            if (workdays === 0) {
                alert('This date range contains no workdays (Sat/Sun/Mon). No PTO will be deducted.');
                return;
            }
            
            const usesReserve = workdays > state.currentBalance;
            const reserveUsed = usesReserve ? workdays - state.currentBalance : 0;
            
            if (usesReserve) {
                const reserveRemaining = calculateReserveRemaining();
                const confirm = window.confirm(
                    `‚ö†Ô∏è RESERVE WARNING\n\n` +
                    `This ${formatDays(workdays)} will use ${formatDays(reserveUsed)} from your 5-day emergency reserve.\n\n` +
                    `Current planning balance: ${formatDays(state.currentBalance)}\n` +
                    `Reserve days available: ${formatDays(reserveRemaining)}\n\n` +
                    `Do you want to proceed?`
                );
                
                if (!confirm) return;
            }
            
            const day = {
                type: 'pto',
                startDate,
                endDate,
                purpose,
                notes,
                daysUsed: workdays,
                balanceAfter: state.currentBalance - workdays,
                usesReserve,
                reserveDaysUsed: reserveUsed,
                toriComing: false
            };
            
            state.plannedDays.push(day);
            state.plannedDays.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            state.currentBalance -= workdays;
            
            saveState();
            cancelPlanPTO();
            updateMainBalance();
            displayPlannedDays();
            
            if (usesReserve) {
                alert(`‚úÖ PTO saved\n\n‚ö†Ô∏è Used ${formatDays(reserveUsed)} from reserve\n\nRemaining balance: ${formatDays(state.currentBalance)}`);
            } else {
                alert(`‚úÖ PTO saved\n\nWorkdays used: ${formatDays(workdays)}\nRemaining balance: ${formatDays(state.currentBalance)}`);
            }
        }
        
        // Show plan non-PTO form
        function showPlanNonPTO() {
            editingIndex = -1;
            document.getElementById('nonPtoFormTitle').textContent = 'Plan Non-PTO Days';
            document.getElementById('planPTOCard').classList.add('hidden');
            document.getElementById('planNonPTOCard').classList.remove('hidden');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('nonPtoStartDate').min = today;
            document.getElementById('nonPtoEndDate').min = today;
            
            document.getElementById('planNonPTOCard').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Cancel plan non-PTO
        function cancelPlanNonPTO() {
            editingIndex = -1;
            document.getElementById('planNonPTOCard').classList.add('hidden');
            document.getElementById('nonPtoStartDate').value = '';
            document.getElementById('nonPtoEndDate').value = '';
            document.getElementById('nonPtoPurpose').value = '';
            document.getElementById('nonPtoNotes').value = '';
        }
        
        // Save non-PTO
        function saveNonPTO() {
            const startDate = document.getElementById('nonPtoStartDate').value;
            const endDate = document.getElementById('nonPtoEndDate').value;
            const purpose = document.getElementById('nonPtoPurpose').value;
            const notes = document.getElementById('nonPtoNotes').value;
            
            if (!startDate || !endDate || !purpose) {
                alert('Please fill in start date, end date, and activity');
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            const day = {
                type: 'non-pto',
                startDate,
                endDate,
                purpose,
                notes,
                daysUsed: 0,
                balanceAfter: state.currentBalance
            };
            
            state.plannedDays.push(day);
            state.plannedDays.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            
            saveState();
            cancelPlanNonPTO();
            displayPlannedDays();
            
            alert(`‚úÖ Days planned (no PTO impact)`);
        }
        
        // FIX 2, 4, 5: Display planned days with inline edit, emojis, hunting orange text, single-line format
        function displayPlannedDays(editIdx = -1, editFormHtml = '') {
            const container = document.getElementById('mainDaysList');
            
            if (state.plannedDays.length === 0) {
                container.innerHTML = '<div class="no-trips">No days planned yet. Start planning!</div>';
                return;
            }
            
            let html = '';
            state.plannedDays.forEach((day, idx) => {
                // FIX 2: Inject edit form above this specific trip
                if (editIdx === idx && editFormHtml) {
                    html += editFormHtml;
                }
                
                const startDate = new Date(day.startDate + 'T00:00:00');
                const endDate = new Date(day.endDate + 'T00:00:00');
                const isSingleDay = day.startDate === day.endDate;
                
                // FIX 5: Compact date format
                let dateStr;
                if (isSingleDay) {
                    dateStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                } else {
                    const startStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    dateStr = `${startStr}-${endStr}`;
                }
                
                const isPTO = day.type === 'pto';
                const cardClass = isPTO ? '' : 'non-pto';
                
                // FIX 4: Get emoji and check if hunting
                const emoji = getEmojiForPurpose(day.purpose);
                const huntingClass = isHunting(day.purpose) ? 'hunting' : '';
                
                // FIX 5: Single line format
                let mainLine = `<span class="trip-emoji">${emoji}</span> ${day.purpose}`;
                mainLine += ` <span class="trip-divider">‚Ä¢</span> ${dateStr}`;
                
                if (isPTO) {
                    mainLine += ` <span class="trip-divider">‚Ä¢</span> ${formatDays(day.daysUsed)} PTO`;
                    if (day.usesReserve) {
                        mainLine += `<span class="reserve-badge">RESERVE</span>`;
                    }
                } else {
                    mainLine += ` <span class="trip-divider">‚Ä¢</span> No PTO`;
                }
                
                html += `
                    <div class="trip-card ${cardClass}">
                        <div class="trip-main-line ${huntingClass}">
                            ${mainLine}
                        </div>
                        <div class="trip-actions">
                            <button class="edit-btn" onclick="editDay(${idx})">‚úèÔ∏è</button>
                            <button class="delete-btn" onclick="deleteDay(${idx})">üóëÔ∏è</button>
                        </div>
                        ${day.notes ? `
                            <div class="trip-notes-compact">
                                üìù ${day.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Delete day
        function deleteDay(idx) {
            if (!confirm('Delete this planned day?')) return;
            
            const day = state.plannedDays[idx];
            if (day.type === 'pto') {
                state.currentBalance += day.daysUsed;
            }
            
            state.plannedDays.splice(idx, 1);
            saveState();
            updateMainBalance();
            displayPlannedDays();
        }
        
        // Show holidays
        function showHolidays() {
            const currentYear = new Date().getFullYear();
            
            let html = '<div class="alert alert-info" style="margin-bottom: 20px;">';
            html += '<strong>Dan\'s Workdays:</strong> Saturday, Sunday, Monday<br>';
            html += '<strong>Dan\'s Paid Holidays:</strong> Thanksgiving & Christmas<br>';
            html += '‚ö†Ô∏è If a holiday falls on your workday, you must use PTO';
            html += '</div>';
            
            html += '<h4 style="color: #2c5f2d; margin: 20px 0 10px;">Thanksgiving & Christmas (Next 3 Years)</h4>';
            html += '<div class="holiday-list">';
            
            for (let year = currentYear; year <= currentYear + 2; year++) {
                // Thanksgiving - 4th Thursday of November
                const nov1 = new Date(year, 10, 1);
                let thursdayCount = 0;
                let thanksgiving = new Date(nov1);
                
                while (thursdayCount < 4) {
                    if (thanksgiving.getDay() === 4) {
                        thursdayCount++;
                        if (thursdayCount === 4) break;
                    }
                    thanksgiving.setDate(thanksgiving.getDate() + 1);
                }
                
                const thanksgivingStr = thanksgiving.toISOString().split('T')[0];
                const thanksgivingIsWorkday = isWorkDay(thanksgivingStr);
                
                html += `
                    <div class="holiday-item ${thanksgivingIsWorkday ? 'workday' : ''}">
                        <strong>Thanksgiving ${year}</strong><br>
                        ${thanksgiving.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}<br>
                        ${thanksgivingIsWorkday ? '<span style="color: #856404;">‚ö†Ô∏è Dan\'s workday - requires PTO</span>' : '<span style="color: #28a745;">‚úì Dan\'s paid holiday</span>'}
                    </div>
                `;
                
                // Christmas - December 25
                const christmas = new Date(year, 11, 25);
                const christmasStr = christmas.toISOString().split('T')[0];
                const christmasIsWorkday = isWorkDay(christmasStr);
                
                html += `
                    <div class="holiday-item ${christmasIsWorkday ? 'workday' : ''}">
                        <strong>Christmas ${year}</strong><br>
                        ${christmas.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}<br>
                        ${christmasIsWorkday ? '<span style="color: #856404;">‚ö†Ô∏è Dan\'s workday - requires PTO</span>' : '<span style="color: #28a745;">‚úì Dan\'s paid holiday</span>'}
                    </div>
                `;
            }
            
            html += '</div>';
            
            document.getElementById('holidaysList').innerHTML = html;
            document.getElementById('holidaysCard').classList.remove('hidden');
        }
        
        function hideHolidays() {
            document.getElementById('holidaysCard').classList.add('hidden');
        }
        
        // Show projections
        function showProjections() {
            const feb1Next = new Date(new Date().getFullYear() + 1, 1, 1);
            const reserveUsedThisYear = calculateReserveUsed();
            const nextYearPlanning = 22 - reserveUsedThisYear;
            const reserveRemaining = calculateReserveRemaining();
            
            let html = '<div class="projection">';
            html += '<h4>Current Status</h4>';
            html += `<p><strong>Planning Balance:</strong> ${formatDays(state.currentBalance)}</p>`;
            html += `<p><strong>Reserve Days Remaining:</strong> ${formatDays(reserveRemaining)}</p>`;
            html += `<p><strong>Reserve Used This Year:</strong> ${formatDays(reserveUsedThisYear)}</p>`;
            html += '</div>';
            
            const ptoTrips = state.plannedDays.filter(day => day.type === 'pto');
            if (ptoTrips.length > 0) {
                html += '<div class="projection">';
                html += '<h4>Planned PTO Trips</h4>';
                ptoTrips.forEach(trip => {
                    const startDate = new Date(trip.startDate + 'T00:00:00');
                    const endDate = new Date(trip.endDate + 'T00:00:00');
                    const dateStr = trip.startDate === trip.endDate 
                        ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                    
                    html += `<p><strong>${trip.purpose}:</strong> ${dateStr} - ${formatDays(trip.daysUsed)}${trip.usesReserve ? ' <span style="color: #856404;">(uses reserve)</span>' : ''}</p>`;
                });
                html += '</div>';
            }
            
            const nonPtoTrips = state.plannedDays.filter(day => day.type === 'non-pto');
            if (nonPtoTrips.length > 0) {
                html += '<div class="projection">';
                html += '<h4>Planned Non-PTO Days (Regular Days Off)</h4>';
                nonPtoTrips.forEach(trip => {
                    const startDate = new Date(trip.startDate + 'T00:00:00');
                    const endDate = new Date(trip.endDate + 'T00:00:00');
                    const dateStr = trip.startDate === trip.endDate 
                        ? startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                        : `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                    
                    html += `<p><strong>${trip.purpose}:</strong> ${dateStr} <span style="color: #6c757d;">(no PTO impact)</span></p>`;
                });
                html += '</div>';
            }
            
            html += '<div class="projection">';
            html += `<h4>Next PTO Year (Feb 1, ${feb1Next.getFullYear()})</h4>`;
            html += `<p><strong>New Annual Grant:</strong> 22 days</p>`;
            if (reserveUsedThisYear > 0) {
                html += `<p style="color: #856404;"><strong>Minus Payback:</strong> -${formatDays(reserveUsedThisYear)} (to restore reserve)</p>`;
            }
            html += `<p><strong>Planning Allowance:</strong> ${formatDays(nextYearPlanning)}</p>`;
            html += `<p><strong>Reserve:</strong> 5 days (restored)</p>`;
            html += `<p><strong>Total Available:</strong> ${formatDays(nextYearPlanning + 5)}</p>`;
            html += '</div>';
            
            if (reserveUsedThisYear > 0) {
                html += '<div class="alert alert-warning">';
                html += `<strong>‚ö†Ô∏è Reserve Payback Notice:</strong><br>`;
                html += `You've used ${formatDays(reserveUsedThisYear)} from reserve this year. `;
                html += `On Feb 1, ${feb1Next.getFullYear()}, your planning allowance will be ${formatDays(nextYearPlanning)} `;
                html += `(22 days minus ${formatDays(reserveUsedThisYear)} payback to restore the 5-day reserve).`;
                html += '</div>';
            }
            
            document.getElementById('projectionsList').innerHTML = html;
            document.getElementById('projectionsCard').classList.remove('hidden');
        }
        
        function hideProjections() {
            document.getElementById('projectionsCard').classList.add('hidden');
        }
        
        // Initialize
        async function init() {
            await loadState();
            document.getElementById('currentBalance').value = state.currentBalance;
        }
        
        init();
    </script>
</body>
</html>
